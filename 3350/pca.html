<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Interactive PCA: 5 Samples × 5 Features → 2D Space</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" defer></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/numeric/1.2.6/numeric.min.js" defer></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --bg:#17191a;
      --panel:#222025;
      --ink:#ff79c6;
      --ink2:#ffb3de;
      --text:#ffd7f0;
      --muted:#b9a7b3;
      --teal:#10b981;
      --cyan:#8be9fd;
      --gold:#f59e0b;
      --violet:#a855f7;
      --border:rgba(255,121,198,.25);
    }
    html, body{
      font-family:'Roboto',Arial,sans-serif;
      background:var(--bg);
      min-height:100vh;
      color:var(--ink);
    }
    .container{
      max-width:1400px;
      margin:0 auto;
      padding:20px;
    }
    header{
      text-align:center;
      margin-bottom:40px;
      padding:30px 20px;
      background:linear-gradient(135deg, #2a1e28 0%, #47223c 100%);
      border-radius:12px;
      border:2px solid var(--border);
      box-shadow:0 4px 30px rgba(255,121,198,.12);
    }
    h1{
      font-size:2.8em;
      color:var(--ink2);
      margin-bottom:8px;
      text-shadow:0 2px 16px rgba(255,121,198,.18);
    }
    .subtitle{
      color:var(--text);
      font-size:1.1em;
      opacity:0.9;
    }
    section{
      background:var(--panel);
      border-radius:18px;
      border-left:7px solid var(--ink);
      box-shadow:0 4px 30px rgba(255,121,198,.09);
      padding:30px;
      margin-bottom:30px;
    }
    h2{
      color:var(--ink2);
      font-size:1.6em;
      margin-bottom:15px;
      border-bottom:2px solid var(--ink);
      padding-bottom:10px;
    }
    h3{
      font-size:1.15em;
      color:var(--text);
      margin:25px 0 15px 0;
      font-weight:600;
      padding:10px;
      background:#2a252b;
      border-left:4px solid var(--teal);
      border-radius:4px;
    }
    h4{
      font-size:1em;
      color:var(--ink2);
      margin:15px 0 8px 0;
      font-weight:600;
    }
    p{color:var(--text);line-height:1.8;margin-bottom:12px}

    button{
      background:var(--teal);
      color:#000;
      padding:10px 18px;
      border:none;
      border-radius:6px;
      font-weight:600;
      cursor:pointer;
      transition:all 0.2s;
      font-size:0.95em;
    }
    button:hover{
      background:#0fa169;
      transform:translateY(-2px);
      box-shadow:0 4px 12px rgba(16,185,129,0.4);
    }
    button.secondary{
      background:var(--cyan);
      color:#000;
    }
    button.secondary:hover{
      background:#6be4ff;
    }
    .button-group{
      display:flex;
      gap:10px;
      margin-top:15px;
      flex-wrap:wrap;
    }
    .button-group button{
      flex:1;
      min-width:100px;
    }

    .data-table{
      width:100%;
      border-collapse:collapse;
      margin:15px 0;
      font-size:1.1em;
    }
    .data-table th{
      background:#1a1d1f;
      color:var(--ink2);
      padding:12px 15px;
      border:1px solid var(--border);
      font-weight:600;
      text-align:center;
    }
    .data-table td{
      padding:10px 15px;
      border:1px solid var(--border);
      background:#1a1d1f;
      color:var(--text);
      text-align:center;
    }
    .data-table tr:hover td{ background:#2a252b; }
    .data-table input{
      width:90%;
      padding:4px;
      background:#0a0e27;
      border:1px solid var(--cyan);
      color:var(--cyan);
      text-align:center;
      border-radius:4px;
      font-family:monospace;
    }

    .grid-2col{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:20px;
      margin-bottom:20px;
    }
    @media(max-width:1200px){
      .grid-2col{ grid-template-columns:1fr; }
    }

    .grid-3col{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:15px;
      margin:15px 0;
    }
    @media(max-width:1000px){
      .grid-3col{ grid-template-columns:1fr; }
    }

    .chart-container{
      background:#1a1d1f;
      border:1px solid var(--border);
      border-radius:8px;
      padding:15px;
      height:420px;
      margin:15px 0;
      position:relative;
    }

    .canvas-wrapper{
      position:relative;
      width:100%;
      height:420px;
      background:#1a1d1f;
      border:1px solid var(--border);
      border-radius:8px;
      margin:15px 0;
    }

    .stat-box{
      background:#1a1d1f;
      border:1px solid var(--border);
      border-radius:8px;
      padding:12px;
      text-align:center;
    }
    .stat-label{ color:var(--muted); font-size:0.85em; margin-bottom:4px; }
    .stat-value{ color:var(--cyan); font-size:1.5em; font-weight:700; }

    .stats-grid{
      display:grid;
      grid-template-columns:repeat(2, 1fr);
      gap:10px;
      margin:15px 0;
    }

    .step-box{
      background:#2a252b;
      border-left:4px solid var(--cyan);
      border-radius:8px;
      padding:15px;
      margin:12px 0;
      color:var(--text);
      font-size:0.95em;
    }
    .step-box strong{ color:var(--cyan); }

    .result-box{
      background:#0a1f12;
      border:2px solid var(--teal);
      border-radius:8px;
      padding:15px;
      margin:15px 0;
      color:#e9fff6;
    }
    .result-box strong{ color:#10b981; }

    .comparison-card{
      background:#1a1d1f;
      border:1px solid var(--border);
      border-radius:8px;
      padding:12px;
    }
    .comparison-card h4{ color:var(--cyan); margin-bottom:8px; margin-top:0; }
    .comparison-card ul{ margin:0; padding-left:18px; color:var(--text); font-size:0.9em; }
    .comparison-card li{ margin:4px 0; }

    .pc-interpretation{
      background:#1a0f2e;
      border-left:4px solid var(--violet);
      border-radius:8px;
      padding:12px;
      margin:12px 0;
      color:var(--text);
      font-size:0.95em;
    }
    .pc-interpretation strong{ color:var(--violet); }

    .full-width{ grid-column:1 / -1; }

    .tab-buttons{
      display:flex;
      gap:10px;
      margin-bottom:15px;
      border-bottom:1px solid var(--border);
      flex-wrap:wrap;
    }
    .tab-btn{
      background:none;
      border:none;
      color:var(--text);
      padding:10px 15px;
      cursor:pointer;
      border-bottom:2px solid transparent;
      transition:all 0.2s;
      font-size:0.9em;
    }
    .tab-btn:hover{ color:var(--cyan); }
    .tab-btn.active{ color:var(--cyan); border-bottom-color:var(--cyan); }

    .tab-content{ display:none; }
    .tab-content.active{ display:block; }

    .variance-bar{
      display:flex; align-items:center; margin:8px 0; height:30px;
      background:#1a1d1f; border-radius:6px; border:1px solid var(--border); overflow:hidden;
    }
    .variance-fill{
      height:100%; display:flex; align-items:center; justify-content:flex-end;
      padding-right:8px; color:#000; font-weight:600; font-size:0.85em;
    }
    .variance-label{ min-width:60px; padding:0 8px; color:var(--text); font-size:0.9em; font-weight:600; }

    .footer{
      text-align:center; margin-top:40px; padding:20px; color:var(--muted);
      font-size:0.9em; border-top:1px solid var(--border);
    }

    .step-indicator{
      display:flex; justify-content:space-between; margin:20px 0; font-size:0.85em;
      flex-wrap:wrap; gap:5px;
    }
    .step{
      flex:1; min-width:80px; padding:8px; text-align:center; border-radius:6px;
      background:#1a1d1f; border:1px solid var(--border); color:var(--text);
    }
    .step.active{ background:var(--teal); color:#000; font-weight:600; }

    .calculation-box{
      background:#1a1d1f; border:1px solid var(--border); border-radius:8px;
      padding:15px; margin:12px 0; font-family:monospace; font-size:0.85em; line-height:1.8;
      color:var(--text); overflow-x:auto;
    }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1><i class="fas fa-chart-line"></i> Interactive PCA Demo</h1>
    <p class="subtitle">5 Samples × 5 Features → 2D PCA Space | Edit data & watch transformations in real-time</p>
  </header>

  <div class="step-indicator">
    <div class="step active"><i class="fas fa-1"></i> Raw Data</div>
    <div class="step"><i class="fas fa-2"></i> Standardize</div>
    <div class="step"><i class="fas fa-3"></i> Covariance</div>
    <div class="step"><i class="fas fa-4"></i> Eigen</div>
    <div class="step"><i class="fas fa-5"></i> Project</div>
  </div>

  <!-- INPUT SECTION -->
  <section class="full-width">
    <h2><i class="fas fa-database"></i> Step 1: Input Data (5 Samples × 5 Features)</h2>
    <p style="color:var(--text);margin-bottom:15px">Edit the values below. All calculations update automatically!</p>

    <table class="data-table">
      <thead>
        <tr>
          <th>Employee</th>
          <th>Productivity</th>
          <th>Accuracy</th>
          <th>Teamwork</th>
          <th>Leadership</th>
          <th>Innovation</th>
        </tr>
      </thead>
      <tbody id="dataTableBody"></tbody>
    </table>

    <div class="button-group">
      <button onclick="loadPreset('correlated')"><i class="fas fa-link"></i> High Correlation</button>
      <button class="secondary" onclick="loadPreset('moderate')"><i class="fas fa-shuffle"></i> Moderate</button>
      <button class="secondary" onclick="loadPreset('random')"><i class="fas fa-dice"></i> Random</button>
      <button class="secondary" onclick="resetData()"><i class="fas fa-redo"></i> Reset</button>
    </div>
  </section>

  <!-- STEPS VISUALIZATION -->
  <div class="grid-2col">
    <!-- STEP 2: STANDARDIZATION -->
    <section id="standardization-section">
      <h2><i class="fas fa-normalize"></i> Step 2: Standardization</h2>
      <p>Standardize each feature: (x - mean) / std</p>

      <div class="tab-buttons" role="tablist" aria-label="Standardization tabs">
        <button class="tab-btn active" data-btn="stats" onclick="showStdTab('stats')" role="tab" aria-controls="stats" aria-selected="true">Statistics</button>
        <button class="tab-btn" data-btn="standardized" onclick="showStdTab('standardized')" role="tab" aria-controls="standardized" aria-selected="false">Standardized Data</button>
      </div>

      <div id="stats" class="tab-content active" role="tabpanel" aria-labelledby="stats-tab">
        <h4 style="margin-top:0">Feature Statistics</h4>
        <table class="data-table">
          <thead>
            <tr>
              <th>Feature</th>
              <th>Mean</th>
              <th>Std Dev</th>
            </tr>
          </thead>
          <tbody id="statsTable"></tbody>
        </table>
      </div>

      <div id="standardized" class="tab-content" role="tabpanel" aria-labelledby="standardized-tab">
        <h4 style="margin-top:0">Standardized Matrix</h4>
        <div id="standardizedMatrix"></div>
      </div>
    </section>

    <!-- STEP 3: COVARIANCE -->
    <section>
      <h2><i class="fas fa-square"></i> Step 3: Covariance Matrix</h2>
      <p>Correlation between standardized features</p>
      <div id="covMatrix"></div>
      <div class="step-box">
        <strong>Interpretation:</strong> Values close to ±1 indicate strong correlation (good for compression).
      </div>
    </section>
  </div>

  <!-- STEP 4: EIGENDECOMPOSITION -->
  <section class="full-width">
    <h2><i class="fas fa-chart-pie"></i> Step 4: Eigendecomposition</h2>
    <p>Find eigenvalues and eigenvectors of covariance matrix</p>

    <div class="grid-2col">
      <div>
        <h4>Eigenvalues (Variance)</h4>
        <table class="data-table">
          <thead>
            <tr>
              <th>PC</th>
              <th>Eigenvalue</th>
              <th>Variance %</th>
              <th>Cumulative %</th>
            </tr>
          </thead>
          <tbody id="eigenvaluesTable"></tbody>
        </table>
      </div>

      <div>
        <h4>Variance Explained</h4>
        <div class="stats-grid">
          <div class="stat-box">
            <div class="stat-label">PC1</div>
            <div class="stat-value" id="pc1Var">--</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">PC2</div>
            <div class="stat-value" id="pc2Var">--</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">PC1+PC2</div>
            <div class="stat-value" id="pc1pc2Var">--</div>
          </div>
          <div class="stat-box">
            <div class="stat-label">Remaining</div>
            <div class="stat-value" id="remainingVar">--</div>
          </div>
        </div>
      </div>
    </div>

    <h3>Variance Explained Visualization</h3>
    <div id="varianceBars"></div>

    <h3>PC Loadings (Feature Contributions)</h3>
    <p style="font-size:0.9em;margin-bottom:10px">How much each original feature contributes to PC1 and PC2:</p>
    <div id="loadingsMatrix"></div>
  </section>

  <!-- STEP 5: VISUALIZATION -->
  <section class="full-width">
    <h2><i class="fas fa-arrows"></i> Step 5: Projections & Visualizations</h2>

    <div class="tab-buttons">
      <button class="tab-btn active" onclick="switchTab(event, 'pca-scatter')">PCA Scatter Plot</button>
      <button class="tab-btn" onclick="switchTab(event, 'biplot')">Biplot (Features)</button>
      <button class="tab-btn" onclick="switchTab(event, 'pc1proj')">PC1 Projection</button>
      <button class="tab-btn" onclick="switchTab(event, 'pc2proj')">PC2 Projection</button>
    </div>

    <div id="pca-scatter" class="tab-content active">
      <h4>Samples in PCA 2D Space</h4>
      <p style="font-size:0.9em;margin-bottom:10px">PC1 vs PC2: Shows how original 5D data reduces to 2D while preserving structure</p>
      <div class="chart-container">
        <canvas id="pcaChart"></canvas>
      </div>
    </div>

    <div id="biplot" class="tab-content">
      <h4>Biplot: Samples + Feature Vectors</h4>
      <p style="font-size:0.9em;margin-bottom:10px">Cyan arrows show how original features project onto PC1-PC2 space</p>
      <div class="canvas-wrapper">
        <canvas id="biplotCanvas"></canvas>
      </div>
    </div>

    <div id="pc1proj" class="tab-content">
      <h4>PC1 Projection (1D)</h4>
      <p style="font-size:0.9em;margin-bottom:10px">Samples positioned along PC1 axis only</p>
      <div class="canvas-wrapper">
        <canvas id="pc1Projection"></canvas>
      </div>
    </div>

    <div id="pc2proj" class="tab-content">
      <h4>PC2 Projection (1D)</h4>
      <p style="font-size:0.9em;margin-bottom:10px">Samples positioned along PC2 axis only</p>
      <div class="canvas-wrapper">
        <canvas id="pc2Projection"></canvas>
      </div>
    </div>

    <h3 style="margin-top:25px">Comparison: Before vs After PCA</h3>
    <div class="grid-2col">
      <div class="comparison-card">
        <h4><i class="fas fa-cube"></i> Original 5D Space</h4>
        <ul>
          <li><strong>Dimensions:</strong> 5</li>
          <li><strong>Features:</strong> F1, F2, F3, F4, F5</li>
          <li><strong>Hard to visualize</strong></li>
          <li><strong>May have noise/redundancy</strong></li>
        </ul>
      </div>
      <div class="comparison-card">
        <h4><i class="fas fa-chart-scatter"></i> PCA 2D Space</h4>
        <ul>
          <li><strong>Dimensions:</strong> 2 (PC1 + PC2)</li>
          <li><strong>Variance retained:</strong> <span id="varRetained">--</span>%</li>
          <li><strong>Easy to visualize</strong></li>
          <li><strong>Captures main patterns</strong></li>
        </ul>
      </div>
    </div>
  </section>

  <!-- SCREE PLOT -->
  <section class="full-width">
    <h2><i class="fas fa-chart-line"></i> Scree Plot: Choose How Many PCs?</h2>
    <p>Look for the "elbow" — where adding more components doesn't help much</p>
    <div class="chart-container">
      <canvas id="screePlot"></canvas>
    </div>
  </section>

  <!-- PC INTERPRETATIONS -->
  <section class="full-width">
    <h2><i class="fas fa-lightbulb"></i> PC Interpretations</h2>
    <div id="interpretations"></div>
  </section>

  <!-- TRANSFORMED DATA -->
  <section class="full-width">
    <h2><i class="fas fa-table"></i> Transformed Data (PC Scores)</h2>
    <p>Each employee's coordinates in the new 2D PCA space:</p>
    <table class="data-table">
      <thead>
        <tr>
          <th>Employee</th>
          <th>PC1 Score</th>
          <th>PC2 Score</th>
          <th>Distance from Origin</th>
        </tr>
      </thead>
      <tbody id="transformedTableBody"></tbody>
    </table>
  </section>

  <div class="footer">
    <p>💡 <strong>Tip:</strong> Edit any sample value and watch all calculations and visualizations update instantly!</p>
    <p>Data is automatically standardized (mean=0, std=1) before PCA to ensure fair feature weighting.</p>
  </div>
</div>

<script>
// ============================================
// DATA MANAGEMENT
// ============================================
let sampleData = [
  { name: 'Employee 1', productivity: 45, accuracy: 50, teamwork: 42, leadership: 48, innovation: 46 },
  { name: 'Employee 2', productivity: 72, accuracy: 68, teamwork: 75, leadership: 70, innovation: 73 },
  { name: 'Employee 3', productivity: 88, accuracy: 92, teamwork: 85, leadership: 90, innovation: 87 },
  { name: 'Employee 4', productivity: 55, accuracy: 60, teamwork: 58, leadership: 62, innovation: 59 },
  { name: 'Employee 5', productivity: 78, accuracy: 82, teamwork: 80, leadership: 85, innovation: 81 }
];

let chartInstances = {};

// ============================================
// MATH UTILITIES
// ============================================
function standardize(data) {
  const n = data.length;
  const mean = data.reduce((a, b) => a + b, 0) / n;
  const variance = data.reduce((sum, x) => sum + Math.pow(x - mean, 2), 0) / n;
  const std = Math.sqrt(variance) || 1; // guard against zero std
  return { mean, std, data: data.map(x => (x - mean) / std) };
}

function getCovarianceMatrix(matrix) {
  const n = matrix.length;
  const d = matrix[0].length;
  const cov = Array(d).fill(0).map(() => Array(d).fill(0));
  for (let i = 0; i < d; i++) {
    for (let j = 0; j < d; j++) {
      let sum = 0;
      for (let k = 0; k < n; k++) {
        sum += matrix[k][i] * matrix[k][j];
      }
      cov[i][j] = sum / n;
    }
  }
  return cov;
}

function eigenDecomposition(matrix) {
  try {
    const result = numeric.eig(matrix);
    const eigenvalues = Array.from(result.lambda.x);      // length d
    const E = result.E.x;                                 // d×d, eigenvectors as COLUMNS
    const order = eigenvalues.map((v, i) => [v, i]).sort((a, b) => b[0] - a[0]).map(x => x[1]);
    const sortedEigenvalues = order.map(i => eigenvalues[i]);
    const V = E.map(row => order.map(j => row[j]));       // d×d → rows=features, cols=PCs
    return { eigenvalues: sortedEigenvalues, eigenvectors: V };
  } catch (e) {
    console.error('Eigendecomposition failed:', e);
    return { eigenvalues: [], eigenvectors: [] };
  }
}

function projectData(standardizedData, eigenvectors, numComponents) {
  const n = standardizedData.length;
  const projected = Array(n).fill(0).map(() => Array(numComponents).fill(0));
  for (let i = 0; i < n; i++) {
    for (let j = 0; j < numComponents; j++) {
      let sum = 0;
      for (let k = 0; k < standardizedData[i].length; k++) {
        sum += standardizedData[i][k] * eigenvectors[k][j];
      }
      projected[i][j] = sum;
    }
  }
  return projected;
}

// ============================================
// UI INITIALIZATION
// ============================================
function initDataTable() {
  const tbody = document.getElementById('dataTableBody');
  tbody.innerHTML = sampleData.map((sample, idx) => `
    <tr>
      <td>${sample.name}</td>
      <td><input type="number" value="${sample.productivity}" onchange="updateSample(${idx}, 'productivity', this.value)"></td>
      <td><input type="number" value="${sample.accuracy}" onchange="updateSample(${idx}, 'accuracy', this.value)"></td>
      <td><input type="number" value="${sample.teamwork}" onchange="updateSample(${idx}, 'teamwork', this.value)"></td>
      <td><input type="number" value="${sample.leadership}" onchange="updateSample(${idx}, 'leadership', this.value)"></td>
      <td><input type="number" value="${sample.innovation}" onchange="updateSample(${idx}, 'innovation', this.value)"></td>
    </tr>
  `).join('');
}

function updateSample(idx, field, value) {
  sampleData[idx][field] = parseFloat(value) || 0;
  updateAllCalculations();
}

function loadPreset(type) {
  if (type === 'correlated') {
    sampleData = [
      { name: 'Employee 1', productivity: 45, accuracy: 50, teamwork: 42, leadership: 48, innovation: 46 },
      { name: 'Employee 2', productivity: 72, accuracy: 68, teamwork: 75, leadership: 70, innovation: 73 },
      { name: 'Employee 3', productivity: 88, accuracy: 92, teamwork: 85, leadership: 90, innovation: 87 },
      { name: 'Employee 4', productivity: 55, accuracy: 60, teamwork: 58, leadership: 62, innovation: 59 },
      { name: 'Employee 5', productivity: 78, accuracy: 82, teamwork: 80, leadership: 85, innovation: 81 }
    ];
  } else if (type === 'moderate') {
    sampleData = [
      { name: 'Employee 1', productivity: 45, accuracy: 70, teamwork: 55, leadership: 48, innovation: 80 },
      { name: 'Employee 2', productivity: 72, accuracy: 45, teamwork: 75, leadership: 80, innovation: 50 },
      { name: 'Employee 3', productivity: 88, accuracy: 75, teamwork: 85, leadership: 60, innovation: 90 },
      { name: 'Employee 4', productivity: 55, accuracy: 85, teamwork: 58, leadership: 72, innovation: 65 },
      { name: 'Employee 5', productivity: 78, accuracy: 55, teamwork: 80, leadership: 65, innovation: 75 }
    ];
  } else if (type === 'random') {
    sampleData = Array(5).fill(0).map((_, i) => ({
      name: `Employee ${i+1}`,
      productivity: Math.floor(Math.random() * 50 + 30),
      accuracy: Math.floor(Math.random() * 50 + 30),
      teamwork: Math.floor(Math.random() * 50 + 30),
      leadership: Math.floor(Math.random() * 50 + 30),
      innovation: Math.floor(Math.random() * 50 + 30)
    }));
  }
  initDataTable();
  updateAllCalculations();
}

function resetData() {
  sampleData = [
    { name: 'Employee 1', productivity: 45, accuracy: 50, teamwork: 42, leadership: 48, innovation: 46 },
    { name: 'Employee 2', productivity: 72, accuracy: 68, teamwork: 75, leadership: 70, innovation: 73 },
    { name: 'Employee 3', productivity: 88, accuracy: 92, teamwork: 85, leadership: 90, innovation: 87 },
    { name: 'Employee 4', productivity: 55, accuracy: 60, teamwork: 58, leadership: 62, innovation: 59 },
    { name: 'Employee 5', productivity: 78, accuracy: 82, teamwork: 80, leadership: 85, innovation: 81 }
  ];
  initDataTable();
  updateAllCalculations();
}

// --------- FIXED: Step 2 Tabs (scoped, no event needed) ----------
function showStdTab(whichId){
  const sec = document.getElementById('standardization-section');
  if(!sec) return;

  // panes
  sec.querySelectorAll('.tab-content').forEach(p => p.classList.remove('active'));
  const pane = sec.querySelector(`#${whichId}`);
  if (pane) pane.classList.add('active');

  // buttons
  sec.querySelectorAll('.tab-btn').forEach(b => {
    b.classList.remove('active');
    b.setAttribute('aria-selected','false');
  });
  const btn = sec.querySelector(`.tab-btn[data-btn="${whichId}"]`);
  if (btn) { btn.classList.add('active'); btn.setAttribute('aria-selected','true'); }
}

// --------- Step 5 Tabs (uses event, separate group) ----------
function switchTab(evt, tabId) {
  const section = evt.currentTarget.closest('section');
  section.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  section.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
  section.querySelector('#' + tabId).classList.add('active');
  evt.currentTarget.classList.add('active');

  // After layout updates, recompute & redraw so canvases get real width
  setTimeout(() => {
    updateAllCalculations();
    if (chartInstances.pca) chartInstances.pca.resize?.();
    if (chartInstances.scree) chartInstances.scree.resize?.();
  }, 50);
}

// ============================================
// MAIN CALCULATIONS
// ============================================
function updateAllCalculations() {
  const features = ['productivity', 'accuracy', 'teamwork', 'leadership', 'innovation'];
  const rawData = sampleData.map(s => features.map(f => s[f]));

  // Step 2: Standardize
  const standardizedByFeature = features.map(f => {
    const values = sampleData.map(s => s[f]);
    return standardize(values);
  });

  const standardizedData = rawData.map((row) =>
    row.map((val, j) => (val - standardizedByFeature[j].mean) / (standardizedByFeature[j].std || 1))
  );

  // Step 3: Covariance
  const covMatrix = getCovarianceMatrix(standardizedData);

  // Step 4: Eigendecomposition
  const eig = eigenDecomposition(covMatrix);
  const eigenvalues = eig.eigenvalues;
  const eigenvectors = eig.eigenvectors;

  // Step 5: Project to 2D
  const projected = projectData(standardizedData, eigenvectors, 2);

  // Update all UI
  updateStats(standardizedByFeature);
  updateStandardizedMatrix(standardizedData);
  updateCovarianceMatrix(covMatrix);
  updateEigenvaluesTable(eigenvalues);
  updateVarianceExplained(eigenvalues);
  updateLoadingsMatrix(eigenvectors);
  updateVarianceBars(eigenvalues);
  updatePCAChart(projected);
  updateBiplot(projected, eigenvectors);
  updatePC1Projection(projected);
  updatePC2Projection(projected);
  updateScreePlot(eigenvalues);
  updateTransformedTable(projected);
  updateInterpretations(eigenvectors);
  updateComparisons(eigenvalues);
}

// ============================================
// UPDATE FUNCTIONS
// ============================================
function updateStats(standardizedByFeature) {
  const features = ['Productivity', 'Accuracy', 'Teamwork', 'Leadership', 'Innovation'];
  const tbody = document.getElementById('statsTable');
  tbody.innerHTML = standardizedByFeature.map((feat, i) => `
    <tr>
      <td>${features[i]}</td>
      <td>${feat.mean.toFixed(6)}</td>
      <td>${feat.std.toFixed(4)}</td>
    </tr>
  `).join('');
}

function updateStandardizedMatrix(matrix) {
  const features = ['Productivity', 'Accuracy', 'Teamwork', 'Leadership', 'Innovation'];
  let html = '<table class="data-table">';
  html += '<thead><tr><th>Employee</th>' + features.map(f=>`<th>${f}</th>`).join('') + '</tr></thead>';
  html += '<tbody>';
  matrix.forEach((row, i) => {
    html += '<tr>';
    html += `<td><strong>Employee ${i+1}</strong></td>`;
    row.forEach(v => { html += `<td>${v.toFixed(3)}</td>`; });
    html += '</tr>';
  });
  html += '</tbody></table>';
  document.getElementById('standardizedMatrix').innerHTML = html;
}

function updateCovarianceMatrix(cov) {
  const features = ['Productivity', 'Accuracy', 'Teamwork', 'Leadership', 'Innovation'];
  let html = '<table class="data-table">';
  html += '<thead><tr><th>Feature</th>' + features.map(f=>`<th>${f}</th>`).join('') + '</tr></thead>';
  html += '<tbody>';
  cov.forEach((row, i) => {
    html += '<tr>';
    html += `<td><strong>${features[i]}</strong></td>`;
    row.forEach(v => { html += `<td>${v.toFixed(3)}</td>`; });
    html += '</tr>';
  });
  html += '</tbody></table>';
  document.getElementById('covMatrix').innerHTML = html;
}

function updateEigenvaluesTable(eigenvalues) {
  const total = eigenvalues.reduce((a, b) => a + b, 0);
  let cumulative = 0;
  const tbody = document.getElementById('eigenvaluesTable');
  tbody.innerHTML = eigenvalues.map((val, i) => {
    const pct = (val / total) * 100;
    cumulative += pct;
    return `
      <tr>
        <td>PC${i+1}</td>
        <td>${val.toFixed(4)}</td>
        <td>${pct.toFixed(1)}%</td>
        <td>${cumulative.toFixed(1)}%</td>
      </tr>
    `;
  }).join('');
}

function updateVarianceExplained(eigenvalues) {
  const total = eigenvalues.reduce((a, b) => a + b, 0);
  const pc1 = (eigenvalues[0] / total * 100).toFixed(1);
  const pc2 = (eigenvalues[1] / total * 100).toFixed(1);
  const pc1pc2 = (parseFloat(pc1) + parseFloat(pc2)).toFixed(1);
  const remaining = (100 - parseFloat(pc1pc2)).toFixed(1);
  document.getElementById('pc1Var').textContent = pc1 + '%';
  document.getElementById('pc2Var').textContent = pc2 + '%';
  document.getElementById('pc1pc2Var').textContent = pc1pc2 + '%';
  document.getElementById('remainingVar').textContent = remaining + '%';
}

function updateLoadingsMatrix(eigenvectors) {
  const features = ['Productivity', 'Accuracy', 'Teamwork', 'Leadership', 'Innovation'];
  let html = '<table class="data-table">';
  html += '<thead><tr><th>Feature</th>' + Array.from({length:5}, (_,j)=>`<th>PC${j+1}</th>`).join('') + '</tr></thead>';
  html += '<tbody>';
  eigenvectors.forEach((row, i) => {
    html += '<tr>';
    html += `<td><strong>${features[i]}</strong></td>`;
    for (let j = 0; j < 5; j++) {
      const v = row[j] || 0;
      html += `<td>${v.toFixed(3)}</td>`;
    }
    html += '</tr>';
  });
  html += '</tbody></table>';
  document.getElementById('loadingsMatrix').innerHTML = html;
}

function updateVarianceBars(eigenvalues) {
  const total = eigenvalues.reduce((a, b) => a + b, 0);
  let cumulative = 0;
  const colors = ['#10b981', '#8be9fd', '#f59e0b', '#a855f7', '#FF6B6B'];
  const html = eigenvalues.map((val, i) => {
    cumulative += val / total * 100;
    const pct = (val / total * 100).toFixed(1);
    return `
      <div class="variance-bar">
        <div class="variance-label">PC${i+1}</div>
        <div class="variance-fill" style="width:${pct}%; background:${colors[i]}">${pct}%</div>
        <div style="min-width:100px; text-align:right; color:var(--text); font-size:0.8em;">(Cumul: ${cumulative.toFixed(1)}%)</div>
      </div>
    `;
  }).join('');
  document.getElementById('varianceBars').innerHTML = html;
}

function updatePCAChart(projected) {
  const ctx = document.getElementById('pcaChart').getContext('2d');
  const colors = ['#FF6B6B', '#4ECDC4', '#10b981', '#f59e0b', '#a855f7'];
  if (chartInstances.pca) chartInstances.pca.destroy();
  chartInstances.pca = new Chart(ctx, {
    type: 'scatter',
    data: {
      datasets: sampleData.map((s, i) => ({
        label: s.name,
        data: [{ x: projected[i][0], y: projected[i][1] }],
        backgroundColor: colors[i],
        borderColor: '#fff',
        borderWidth: 2,
        pointRadius: 8,
        pointHoverRadius: 10
      }))
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: '#ffd7f0' } },
        title: { display: true, text: '5D Data Projected to 2D PCA Space', color: '#ffb3de', font: { size: 14 } },
        tooltip: { backgroundColor: '#1a1d1f', borderColor: '#ff79c6', borderWidth: 1, titleColor: '#fff', bodyColor: '#ffd7f0' }
      },
      scales: {
        x: { title: { display: true, text: 'PC1 (First Principal Component)', color: '#ffb3de' }, ticks: { color: '#ffd7f0' }, grid: { color: 'rgba(255,255,255,.1)' } },
        y: { title: { display: true, text: 'PC2 (Second Principal Component)', color: '#ffb3de' }, ticks: { color: '#ffd7f0' }, grid: { color: 'rgba(255,255,255,.1)' } }
      }
    }
  });
}

function updateBiplot(projected, eigenvectors) {
  const canvas = document.getElementById('biplotCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const container = canvas.parentElement;
  const width = container.clientWidth;
  const height = 420;
  canvas.width = width; canvas.height = height;

  const centerX = width / 2;
  const centerY = height / 2;
  const scale = 60;

  ctx.fillStyle = '#1a1d1f';
  ctx.fillRect(0, 0, width, height);

  ctx.strokeStyle = 'rgba(255,255,255,0.08)';
  ctx.lineWidth = 1;
  for (let i = -4; i <= 4; i++) {
    ctx.beginPath(); ctx.moveTo(centerX + i * scale, 0); ctx.lineTo(centerX + i * scale, height); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(0, centerY + i * scale); ctx.lineTo(width, centerY + i * scale); ctx.stroke();
  }

  ctx.strokeStyle = '#444'; ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(centerX, 0); ctx.lineTo(centerX, height); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(0, centerY); ctx.lineTo(width, centerY); ctx.stroke();

  const features = ['Productivity', 'Accuracy', 'Teamwork', 'Leadership', 'Innovation'];
  features.forEach((feat, i) => {
    const x = eigenvectors[i][0] * scale * 1.5;
    const y = -eigenvectors[i][1] * scale * 1.5;
    drawArrow(ctx, centerX, centerY, centerX + x, centerY + y, '#8be9fd', 2.5);
    ctx.fillStyle = '#8be9fd';
    ctx.font = 'bold 12px Arial';
    ctx.textAlign = 'left';
    ctx.fillText(feat, centerX + x + 8, centerY + y - 8);
  });

  const colors = ['#FF6B6B', '#4ECDC4', '#10b981', '#f59e0b', '#a855f7'];
  projected.forEach((point, i) => {
    const x = point[0] * scale;
    const y = -point[1] * scale;
    ctx.fillStyle = colors[i];
    ctx.beginPath(); ctx.arc(centerX + x, centerY + y, 7, 0, 2 * Math.PI); ctx.fill();
    ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
    ctx.fillStyle = '#fff'; ctx.font = 'bold 11px Arial'; ctx.textAlign = 'center';
    ctx.fillText(sampleData[i].name, centerX + x, centerY + y - 15);
  });

  ctx.font = 'bold 13px Arial'; ctx.fillStyle = '#10b981'; ctx.textAlign = 'left';
  ctx.fillText('PC1 →', width - 80, 30);
  ctx.fillStyle = '#8be9fd'; ctx.textAlign = 'right';
  ctx.fillText('← PC2', 20, 30);
}

function drawArrow(ctx, fromX, fromY, toX, toY, color, lineWidth) {
  const headlen = 12;
  const angle = Math.atan2(toY - fromY, toX - fromX);
  ctx.strokeStyle = color; ctx.lineWidth = lineWidth;
  ctx.beginPath(); ctx.moveTo(fromX, fromY); ctx.lineTo(toX, toY); ctx.stroke();
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.moveTo(toX, toY);
  ctx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), toY - headlen * Math.sin(angle - Math.PI / 6));
  ctx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), toY - headlen * Math.sin(angle + Math.PI / 6));
  ctx.closePath(); ctx.fill();
}

function updatePC1Projection(projected) {
  const canvas = document.getElementById('pc1Projection');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const container = canvas.parentElement;
  const width = container.clientWidth;
  const height = 420;
  canvas.width = width; canvas.height = height;

  ctx.fillStyle = '#1a1d1f'; ctx.fillRect(0, 0, width, height);

  const margin = 50;
  const plotWidth = width - 2 * margin;
  const centerY = height / 2;

  ctx.strokeStyle = '#10b981'; ctx.lineWidth = 3;
  ctx.beginPath(); ctx.moveTo(margin, centerY); ctx.lineTo(width - margin, centerY); ctx.stroke();

  const pc1Values = projected.map(p => p[0]);
  const minVal = Math.min(...pc1Values);
  const maxVal = Math.max(...pc1Values);
  const range = (maxVal - minVal) || 1;

  const colors = ['#FF6B6B', '#4ECDC4', '#10b981', '#f59e0b', '#a855f7'];
  projected.forEach((point, i) => {
    const normalized = (point[0] - minVal) / range;
    const x = margin + normalized * plotWidth;
    ctx.fillStyle = colors[i];
    ctx.beginPath(); ctx.arc(x, centerY, 9, 0, 2 * Math.PI); ctx.fill();
    ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
    ctx.fillStyle = '#fff'; ctx.font = 'bold 12px Arial'; ctx.textAlign = 'center';
    ctx.fillText(sampleData[i].name, x, centerY + 28);
  });

  ctx.fillStyle = '#10b981'; ctx.font = 'bold 12px Arial'; ctx.textAlign = 'center';
  ctx.fillText(minVal.toFixed(2), margin, centerY - 20);
  ctx.fillText(maxVal.toFixed(2), width - margin, centerY - 20);
  ctx.font = 'bold 14px Arial'; ctx.textAlign = 'right'; ctx.fillText('PC1', width - 20, 30);
}

function updatePC2Projection(projected) {
  const canvas = document.getElementById('pc2Projection');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const container = canvas.parentElement;
  const width = container.clientWidth;
  const height = 420;
  canvas.width = width; canvas.height = height;

  ctx.fillStyle = '#1a1d1f'; ctx.fillRect(0, 0, width, height);

  const margin = 50;
  const plotWidth = width - 2 * margin;
  const centerY = height / 2;

  ctx.strokeStyle = '#8be9fd'; ctx.lineWidth = 3;
  ctx.beginPath(); ctx.moveTo(margin, centerY); ctx.lineTo(width - margin, centerY); ctx.stroke();

  const pc2Values = projected.map(p => p[1]);
  const minVal = Math.min(...pc2Values);
  const maxVal = Math.max(...pc2Values);
  const range = (maxVal - minVal) || 1;

  const colors = ['#FF6B6B', '#4ECDC4', '#10b981', '#f59e0b', '#a855f7'];
  projected.forEach((point, i) => {
    const normalized = (point[1] - minVal) / range;
    const x = margin + normalized * plotWidth;
    ctx.fillStyle = colors[i];
    ctx.beginPath(); ctx.arc(x, centerY, 9, 0, 2 * Math.PI); ctx.fill();
    ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
    ctx.fillStyle = '#fff'; ctx.font = 'bold 12px Arial'; ctx.textAlign = 'center';
    ctx.fillText(sampleData[i].name, x, centerY + 28);
  });

  ctx.fillStyle = '#8be9fd'; ctx.font = 'bold 12px Arial'; ctx.textAlign = 'center';
  ctx.fillText(minVal.toFixed(2), margin, centerY - 20);
  ctx.fillText(maxVal.toFixed(2), width - margin, centerY - 20);
  ctx.font = 'bold 14px Arial'; ctx.textAlign = 'right'; ctx.fillText('PC2', width - 20, 30);
}

function updateScreePlot(eigenvalues) {
  const ctx = document.getElementById('screePlot').getContext('2d');
  const total = eigenvalues.reduce((a, b) => a + b, 0);
  const percentages = eigenvalues.map(v => v / total * 100);
  let cumulative = 0;
  const cumulativePercentages = percentages.map(p => (cumulative += p, cumulative));

  if (chartInstances.scree) chartInstances.scree.destroy();

  chartInstances.scree = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ['PC1', 'PC2', 'PC3', 'PC4', 'PC5'],
      datasets: [
        {
          label: 'Individual Variance %',
          data: percentages,
          borderColor: '#8be9fd',
          backgroundColor: 'rgba(139,233,253,0.1)',
          borderWidth: 3,
          pointRadius: 6,
          pointBackgroundColor: '#8be9fd',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          tension: 0.4
        },
        {
          label: 'Cumulative Variance %',
          data: cumulativePercentages,
          borderColor: '#10b981',
          backgroundColor: 'rgba(16,185,129,0.1)',
          borderWidth: 3,
          pointRadius: 6,
          pointBackgroundColor: '#10b981',
          pointBorderColor: '#fff',
          pointBorderWidth: 2,
          tension: 0.4,
          borderDash: [5, 5]
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { labels: { color: '#ffd7f0' } }, title: { display: true, text: 'Scree Plot: Diminishing Returns?', color: '#ffb3de', font: { size: 14 } }, tooltip: { backgroundColor: '#1a1d1f', borderColor: '#ff79c6', borderWidth: 1, titleColor: '#fff', bodyColor: '#ffd7f0' } },
      scales: { y: { min: 0, max: 105, ticks: { color: '#ffd7f0' }, grid: { color: 'rgba(255,255,255,.1)' } }, x: { ticks: { color: '#ffd7f0' }, grid: { color: 'rgba(255,255,255,.1)' } } }
    }
  });
}

function updateTransformedTable(projected) {
  const tbody = document.getElementById('transformedTableBody');
  tbody.innerHTML = sampleData.map((s, i) => {
    const distance = Math.sqrt(projected[i][0] ** 2 + projected[i][1] ** 2);
    return `<tr><td>${s.name}</td><td>${projected[i][0].toFixed(3)}</td><td>${projected[i][1].toFixed(3)}</td><td>${distance.toFixed(3)}</td></tr>`;
  }).join('');
}

function updateInterpretations(eigenvectors) {
  const features = ['Productivity', 'Accuracy', 'Teamwork', 'Leadership', 'Innovation'];
  const pc1 = eigenvectors.map(e => e[0] || 0);
  const pc2 = eigenvectors.map(e => e[1] || 0);

  const html = `
    <div class="pc-interpretation">
      <strong>PC1:</strong> Overall Performance Quality (weighted mix of skills)
      <br><span style="font-size:0.85em">${features.map((f, i) => `${f}: ${pc1[i].toFixed(3)}`).join(' | ')}</span>
    </div>
    <div class="pc-interpretation">
      <strong>PC2:</strong> Skill Specialization (contrasts among skills)
      <br><span style="font-size:0.85em">${features.map((f, i) => `${f}: ${pc2[i].toFixed(3)}`).join(' | ')}</span>
    </div>
  `;
  document.getElementById('interpretations').innerHTML = html;
}

function updateComparisons(eigenvalues) {
  const total = eigenvalues.reduce((a, b) => a + b, 0);
  const varRetained = (((eigenvalues[0] + eigenvalues[1]) / total) * 100).toFixed(1);
  document.getElementById('varRetained').textContent = varRetained;
}

// ============================================
// INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', function() {
  initDataTable();
  // Ensure Step 2 shows Statistics by default and is scoped
  showStdTab('stats');
  updateAllCalculations();
});
</script>

</body>
</html>
