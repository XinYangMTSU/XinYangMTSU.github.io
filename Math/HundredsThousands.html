<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Math Academy</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a2e;
            --panel-color: #16213e;
            --accent: #e94560;
            --highlight: #ffd700;
            --text: #ffffff;
            --neon-blue: #4cc9f0;
            --neon-purple: #7209b7;
        }

        * { box-sizing: border-box; transition: all 0.3s ease; }

        body {
            margin: 0;
            padding: 20px;
            font-family: 'Fredoka', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(white 1px, transparent 1px);
            background-size: 50px 50px;
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            font-size: 3rem;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px var(--neon-blue);
        }

        /* --- NAVIGATION TABS --- */
        .nav-container {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
        }

        .nav-btn {
            background: transparent;
            border: 2px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 15px 30px;
            font-size: 1.2rem;
            border-radius: 15px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
        }

        .nav-btn.active, .nav-btn:hover {
            background: var(--neon-blue);
            color: var(--bg-color);
            box-shadow: 0 0 20px var(--neon-blue);
            transform: scale(1.05);
        }

        /* --- MAIN PANEL --- */
        .main-panel {
            background: var(--panel-color);
            width: 100%;
            max-width: 700px;
            border-radius: 25px;
            padding: 40px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        .settings-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.05);
            padding: 10px 20px;
            border-radius: 15px;
        }

        .toggle-btn {
            background: #333;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 10px;
            cursor: pointer;
            margin-left: 5px;
        }
        .toggle-btn.selected { background: var(--accent); }

        /* --- THE MATH GRID --- */
        .math-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr); /* Spacer + Th, H, T, O */
            gap: 5px;
            font-family: 'Roboto Mono', monospace;
            font-size: 2.5rem;
            font-weight: bold;
            margin: 20px auto;
            width: 100%;
            max-width: 500px;
            position: relative;
        }

        .header-cell {
            font-size: 1rem;
            color: #888;
            text-align: center;
            font-family: 'Fredoka';
            margin-bottom: 5px;
        }

        .cell {
            height: 70px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border-radius: 10px;
        }

        /* Special Elements for Animation/Interaction */
        .carry-input {
            position: absolute;
            top: -25px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid var(--highlight);
            background: var(--bg-color);
            color: var(--highlight);
            text-align: center;
            font-size: 1rem;
            z-index: 10;
        }

        .borrow-strikethrough {
            position: absolute;
            width: 80%;
            height: 3px;
            background-color: var(--accent);
            transform: rotate(-45deg);
            top: 50%;
            left: 10%;
            display: none;
        }

        .borrow-val {
            position: absolute;
            top: -20px;
            left: -5px;
            font-size: 1.5rem;
            color: var(--accent);
            background: var(--bg-color);
            padding: 0 5px;
            border-radius: 5px;
            display: none;
        }

        /* Animation Classes */
        .fly-up {
            animation: flyUpAnim 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }
        @keyframes flyUpAnim {
            0% { transform: translateY(0) scale(1); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(-60px) scale(1.2); opacity: 1; }
        }

        .active-col {
            background-color: rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.2);
        }

        .operator { font-size: 2rem; color: var(--accent); display: flex; align-items: center; justify-content: center;}
        .divider { grid-column: 1 / -1; height: 4px; background: white; border-radius: 2px; margin-bottom: 10px; }

        /* Inputs for Practice Mode */
        .user-input {
            width: 100%;
            height: 100%;
            background: #222;
            border: 2px solid #444;
            color: white;
            font-size: 2rem;
            text-align: center;
            border-radius: 10px;
            font-family: 'Roboto Mono';
        }
        .user-input:focus { outline: none; border-color: var(--neon-blue); }
        .user-input.correct { border-color: #4caf50; background: rgba(76, 175, 80, 0.2); }
        .user-input.wrong { border-color: #f44336; background: rgba(244, 67, 54, 0.2); }

        /* Robot Teacher Area */
        .robot-area {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-top: 20px;
            min-height: 100px;
        }

        .robot-avatar {
            font-size: 3rem;
            animation: bounce 2s infinite;
        }

        .speech-box {
            background: white;
            color: #333;
            padding: 15px;
            border-radius: 0 15px 15px 15px;
            position: relative;
            font-size: 1.1rem;
            line-height: 1.5;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            flex: 1;
        }

        .speech-box::before {
            content: '';
            position: absolute;
            top: 0; left: -10px;
            border-width: 0 10px 10px 0;
            border-style: solid;
            border-color: transparent white transparent transparent;
        }

        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* Buttons */
        .action-bar {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        .primary-btn {
            background: var(--neon-purple);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.3rem;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Fredoka';
            box-shadow: 0 5px 15px rgba(114, 9, 183, 0.4);
        }

        .primary-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(114, 9, 183, 0.6); }
        .primary-btn:active { transform: translateY(2px); }
        .primary-btn:disabled { background: #555; cursor: not-allowed; box-shadow: none; transform: none; }

        .secondary-btn {
            background: transparent;
            border: 2px solid white;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            cursor: pointer;
            font-family: 'Fredoka';
        }

        .hidden { display: none; }
        .fade-in { animation: fade 0.5s; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }

    </style>
</head>
<body>

    <h1>üöÄ Space Math Academy</h1>

    <div class="nav-container">
        <button class="nav-btn active" id="btn-learn" onclick="switchMode('learn')">üéì Training (Learn)</button>
        <button class="nav-btn" id="btn-practice" onclick="switchMode('practice')">‚≠ê Mission (Practice)</button>
    </div>

    <div class="main-panel">

        <div class="settings-bar">
            <div>
                <span>Operation:</span>
                <button class="toggle-btn selected" id="op-add" onclick="setOp('add')">+</button>
                <button class="toggle-btn" id="op-sub" onclick="setOp('sub')">‚àí</button>
            </div>
            <div>
                <span>Difficulty:</span>
                <button class="toggle-btn" id="dig-3" onclick="setDigits(3)">100s</button>
                <button class="toggle-btn selected" id="dig-4" onclick="setDigits(4)">1,000s</button>
            </div>
        </div>

        <div class="math-grid" id="grid-container">
            </div>

        <div class="robot-area">
            <div class="robot-avatar">ü§ñ</div>
            <div class="speech-box" id="robot-text">
                Welcome Cadet! Click <strong>"New Problem"</strong> to begin your training.
            </div>
        </div>

        <div class="action-bar">
            <button class="secondary-btn" onclick="generateProblem()">üîÑ New Problem</button>
            <button class="primary-btn" id="main-action-btn" onclick="handleAction()">Start Lesson ‚û§</button>
        </div>

    </div>

    <script>
        // State Variables
        let appMode = 'learn'; // 'learn' or 'practice'
        let operation = 'add'; // 'add' or 'sub'
        let numDigits = 4;     // 3 or 4

        let num1, num2, answer;
        let digits1, digits2, digitsAns;

        // Learn Mode specific
        let currentStep = 0; // 0 = ones column, 1 = tens, etc.
        let carry = 0;

        // Setup
        function switchMode(mode) {
            appMode = mode;
            document.getElementById('btn-learn').classList.toggle('active', mode === 'learn');
            document.getElementById('btn-practice').classList.toggle('active', mode === 'practice');

            // Update UI Text
            document.getElementById('main-action-btn').innerText = mode === 'learn' ? "Start Lesson ‚û§" : "Check Engines! ‚úì";

            generateProblem();
        }

        function setOp(op) {
            operation = op;
            document.getElementById('op-add').classList.toggle('selected', op === 'add');
            document.getElementById('op-sub').classList.toggle('selected', op === 'sub');
            generateProblem();
        }

        function setDigits(n) {
            numDigits = n;
            document.getElementById('dig-3').classList.toggle('selected', n === 3);
            document.getElementById('dig-4').classList.toggle('selected', n === 4);
            generateProblem();
        }

        function generateProblem() {
            // 1. Generate Numbers
            let min = numDigits === 3 ? 100 : 1000;
            let max = numDigits === 3 ? 999 : 9999;

            if (operation === 'add') {
                // Force a carry for educational value
                num1 = Math.floor(Math.random() * (max/2)) + min;
                num2 = Math.floor(Math.random() * (max/2)) + (min/2);
                // Hack to ensure at least one column sums > 9
                let n1Str = num1.toString();
                let n2Str = num2.toString();
                // ... (logic simplified for brevity, random is usually enough)
                answer = num1 + num2;
            } else {
                // Subtraction: Ensure num1 > num2 and force a borrow
                num1 = Math.floor(Math.random() * (max - min)) + min;
                num2 = Math.floor(Math.random() * (num1 - 100)) + 10;

                // Force a borrow in ones place to make it interesting
                let s1 = num1.toString().split('');
                let s2 = num2.toString().split('');
                if (s1[s1.length-1] >= s2[s2.length-1]) {
                    s1[s1.length-1] = Math.max(0, s2[s2.length-1] - 2);
                    num1 = parseInt(s1.join(''));
                }
                answer = num1 - num2;
            }

            // 2. Prepare Arrays (padded)
            // We use 5 columns max to allow space for operator or 10000s place
            digits1 = num1.toString().padStart(5, ' ').split('');
            digits2 = num2.toString().padStart(5, ' ').split('');
            digitsAns = answer.toString().padStart(5, ' ').split('');

            // 3. Render Grid
            renderGrid();

            // 4. Reset State
            currentStep = 0;
            carry = 0;

            // 5. Update Robot
            if (appMode === 'learn') {
                speak(`We need to solve: <strong>${num1} ${operation==='add' ? '+' : '-'} ${num2}</strong>.<br>Click "Start Lesson" to watch how it works!`);
                document.getElementById('main-action-btn').disabled = false;
                document.getElementById('main-action-btn').innerText = "Start Lesson ‚û§";
            } else {
                speak(`Mission: Solve <strong>${num1} ${operation==='add' ? '+' : '-'} ${num2}</strong>.<br>Type your answer in the boxes. Use the small bubbles for carries or borrowing!`);
                document.getElementById('main-action-btn').disabled = false;
                document.getElementById('main-action-btn').innerText = "Check Engines! ‚úì";
            }
        }

        function renderGrid() {
            const grid = document.getElementById('grid-container');
            grid.innerHTML = '';

            // Headers
            const headers = ['', 'Th', 'H', 'T', 'O']; // Align with 5 columns
            headers.forEach(h => grid.innerHTML += `<div class="header-cell">${h}</div>`);

            // Row 1 (Top Number)
            digits1.forEach((d, i) => {
                let html = `<div class="cell top-row" id="top-${i}" data-val="${d}">`;

                // Visual elements for Borrowing
                html += `<div class="borrow-val" id="bval-${i}"></div>`;
                html += `<div class="borrow-strikethrough" id="strike-${i}"></div>`;

                // Carry bubbles (for user input or animation)
                // In Practice mode, these are inputs. In Learn mode, they are animation targets.
                if (appMode === 'practice' && i > 0 && i < 5) {
                    html += `<input class="carry-input" type="text" maxlength="1" tabindex="-1">`;
                } else {
                    html += `<div class="carry-input" id="carry-${i}" style="opacity:0; border:none;"></div>`;
                }

                html += `<span class="val">${d}</span></div>`;
                grid.innerHTML += html;
            });

            // Row 2 (Bottom Number) with Operator
            digits2.forEach((d, i) => {
                let content = d;
                if (i === 0) {
                    // Place operator in first column if empty, or float it
                    content = `<span class="operator">${operation === 'add' ? '+' : '-'}</span>`;
                    if(d !== ' ') content += d;
                }
                grid.innerHTML += `<div class="cell" id="bot-${i}">${content}</div>`;
            });

            // Divider
            grid.innerHTML += `<div class="divider"></div>`;

            // Row 3 (Answer)
            digitsAns.forEach((d, i) => {
                let html = `<div class="cell ans-row" id="ans-${i}">`;
                if (appMode === 'learn') {
                    html += `<span class="val" style="opacity:0">${d}</span>`;
                } else {
                    // Inputs for practice (only if it's a valid digit position)
                    // We check if digits1 or digits2 have a number here or if it's a carry over
                    if (d !== ' ' || i > 0) {
                        html += `<input class="user-input" id="input-${i}" type="text" maxlength="1">`;
                    }
                }
                html += `</div>`;
                grid.innerHTML += html;
            });
        }

        // --- ACTION HANDLER ---
        function handleAction() {
            if (appMode === 'learn') {
                runLearnStep();
            } else {
                checkPracticeAnswer();
            }
        }

        // --- LEARN MODE LOGIC ---
        function runLearnStep() {
            // Steps go from right (index 4) to left (index 0)
            // We skip index 0 if it's just empty padding
            let col = 4 - currentStep;

            // Check if finished
            if (col < 0 || (digits1[col] === ' ' && digits2[col] === ' ' && carry === 0)) {
                speak("Calculation Complete! Excellent work, cadet! üéâ");
                document.getElementById('main-action-btn').innerText = "Done";
                document.getElementById('main-action-btn').disabled = true;
                return;
            }

            // Highlight Column
            document.querySelectorAll('.cell').forEach(c => c.classList.remove('active-col'));
            let topCell = document.getElementById(`top-${col}`);
            let botCell = document.getElementById(`bot-${col}`);
            let ansCell = document.getElementById(`ans-${col}`);

            if(topCell) topCell.classList.add('active-col');
            if(botCell) botCell.classList.add('active-col');
            if(ansCell) ansCell.classList.add('active-col');

            document.getElementById('main-action-btn').innerText = "Next Step ‚û§";

            if (operation === 'add') {
                teachAddition(col);
            } else {
                teachSubtraction(col);
            }

            currentStep++;
        }

        function teachAddition(col) {
            let d1 = parseInt(digits1[col]) || 0;
            let d2 = parseInt(digits2[col]) || 0;
            let sum = d1 + d2 + carry;

            let txt = "";
            if (carry > 0) {
                txt += `Carry <strong>${carry}</strong> plus ${d1} plus ${d2} is <strong>${sum}</strong>. `;
            } else {
                txt += `${d1} plus ${d2} is <strong>${sum}</strong>. `;
            }

            if (sum > 9) {
                let write = sum % 10;
                let newCarry = Math.floor(sum / 10);
                txt += `That's too big! Write <strong>${write}</strong>, and carry the <strong>${newCarry}</strong> up! üéà`;

                // Visual: Show carried 1 flying up to next col
                let carryBubble = document.getElementById(`carry-${col-1}`);
                if(carryBubble) {
                    carryBubble.innerText = newCarry;
                    carryBubble.style.border = "2px solid var(--highlight)";
                    carryBubble.style.background = "var(--bg-color)";
                    carryBubble.classList.add('fly-up');
                }
                carry = newCarry;
            } else {
                txt += `Write down <strong>${sum}</strong>.`;
                carry = 0;
            }

            // Reveal Answer
            let ansSpan = document.getElementById(`ans-${col}`).querySelector('.val');
            if(ansSpan) {
                ansSpan.style.opacity = 1;
                ansSpan.classList.add('fade-in');
            }
            speak(txt);
        }

        function teachSubtraction(col) {
            // Note: Digits array is visual, logic needs numbers
            let d1 = parseInt(document.getElementById(`top-${col}`).innerText) || 0;
            // Check if visual was updated by previous borrow?
            // Actually, simpler: trust the visual state if we implement borrowing DOM updates immediately.
            // But for 'Learn', let's use the pre-calculated borrowing logic.

            // Simple approach: Check if we need to borrow based on current state
            // If we borrowed previously, the current top digit is 1 less.
            // This state tracking is tricky in a simple script, so we will "simulate" it column by column.

            // Let's read the CURRENT value from the DOM, in case a previous step changed it
            // We look at the 'borrow-val' first, then the main text
            let topDom = document.getElementById(`top-${col}`);
            let borrowValDiv = topDom.querySelector('.borrow-val');
            let mainValDiv = topDom.querySelector('.val');

            let currentTop = borrowValDiv.style.display === 'block' ? parseInt(borrowValDiv.innerText) : parseInt(mainValDiv.innerText);
            if(isNaN(currentTop)) currentTop = 0;

            let d2 = parseInt(digits2[col]) || 0;

            let txt = "";

            if (currentTop >= d2) {
                txt = `${currentTop} minus ${d2} is <strong>${currentTop - d2}</strong>.`;
            } else {
                // Need to borrow from Left
                let leftCol = col - 1;
                let leftDom = document.getElementById(`top-${leftCol}`);
                let leftSpan = leftDom.querySelector('.val');
                let leftVal = parseInt(leftSpan.innerText);

                // Visual Borrow
                leftDom.querySelector('.borrow-strikethrough').style.display = 'block';
                leftDom.querySelector('.borrow-val').innerText = (leftVal - 1);
                leftDom.querySelector('.borrow-val').style.display = 'block';

                // Visual Add to current
                // We show it by putting a '1' next to the current number using the borrow note
                topDom.querySelector('.borrow-strikethrough').style.display = 'block';
                topDom.querySelector('.borrow-val').innerText = (currentTop + 10);
                topDom.querySelector('.borrow-val').style.display = 'block';

                txt = `We can't take ${d2} from ${currentTop}. Knock on the neighbor's door! <br>Borrow 1. Neighbor becomes <strong>${leftVal-1}</strong>. We become <strong>${currentTop+10}</strong>. <br>Now: ${currentTop+10} - ${d2} = <strong>${currentTop+10-d2}</strong>.`;
            }

            // Reveal Answer
            let ansSpan = document.getElementById(`ans-${col}`).querySelector('.val');
            if(ansSpan) {
                ansSpan.style.opacity = 1;
                ansSpan.classList.add('fade-in');
            }
            speak(txt);
        }

        // --- PRACTICE MODE LOGIC ---
        function checkPracticeAnswer() {
            let correct = true;
            let userAnsString = "";

            // Loop through inputs
            // We iterate 0 to 4
            for(let i=0; i<5; i++) {
                let input = document.getElementById(`input-${i}`);
                if(input) {
                    let val = input.value.trim();
                    // If empty, assume 0? Or require exact match?
                    // Let's build the string
                    if(val === "") val = " "; // space for matching
                    userAnsString += val;
                } else {
                    userAnsString += digitsAns[i]; // If no input (padding), assume correct part of string
                }
            }

            // Compare Strings (trimmed)
            let cleanUser = userAnsString.replace(/\s/g, '');
            let cleanReal = answer.toString();

            if (cleanUser == cleanReal) {
                speak("üåü MISSION SUCCESS! All engines go! üåü");
                document.querySelectorAll('.user-input').forEach(i => i.classList.add('correct'));
                // Add confetti or simple effect here
            } else {
                speak("‚ö†Ô∏è Trajectory Error! Check your math columns.");
                document.querySelectorAll('.user-input').forEach(i => {
                    // Simple individual check
                    let idx = i.id.split('-')[1];
                    if (i.value != digitsAns[idx]) i.classList.add('wrong');
                    else { i.classList.remove('wrong'); i.classList.add('correct'); }
                });
            }
        }

        function speak(html) {
            const box = document.getElementById('robot-text');
            box.style.opacity = 0;
            setTimeout(() => {
                box.innerHTML = html;
                box.style.opacity = 1;
            }, 200);
        }

        // Init
        generateProblem();

    </script>
</body>
</html>
