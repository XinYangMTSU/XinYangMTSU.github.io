<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Math Academy: Challenge Mode</title>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Roboto+Mono:wght@500&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #1a1a2e;
            --panel-color: #16213e;
            --accent: #e94560;
            --highlight: #ffd700;
            --text: #ffffff;
            --neon-blue: #4cc9f0;
            --neon-purple: #7209b7;
        }

        * { box-sizing: border-box; transition: all 0.3s ease; }

        body {
            margin: 0;
            padding: 20px;
            font-family: 'Fredoka', sans-serif;
            background-color: var(--bg-color);
            background-image: radial-gradient(white 1px, transparent 1px);
            background-size: 50px 50px;
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            font-size: 2.5rem;
            text-align: center;
            margin-bottom: 20px;
            text-shadow: 0 0 10px var(--neon-blue);
        }

        /* --- NAVIGATION TABS --- */
        .nav-container {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .nav-btn {
            background: transparent;
            border: 2px solid var(--neon-blue);
            color: var(--neon-blue);
            padding: 10px 20px;
            font-size: 1.1rem;
            border-radius: 15px;
            cursor: pointer;
            font-family: inherit;
            font-weight: bold;
        }

        .nav-btn.active, .nav-btn:hover {
            background: var(--neon-blue);
            color: var(--bg-color);
            box-shadow: 0 0 20px var(--neon-blue);
            transform: scale(1.05);
        }

        /* --- MAIN PANEL --- */
        .main-panel {
            background: var(--panel-color);
            width: 100%;
            max-width: 850px; /* Widen for larger numbers */
            border-radius: 25px;
            padding: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.1);
            position: relative;
            overflow: hidden;
        }

        .settings-bar {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.05);
            padding: 15px;
            border-radius: 15px;
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toggle-btn {
            background: #333;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Roboto Mono', monospace;
            font-size: 0.9rem;
        }
        .toggle-btn:hover { background: #444; }
        .toggle-btn.selected { background: var(--accent); font-weight: bold; box-shadow: 0 0 10px var(--accent); }

        /* --- THE MATH GRID --- */
        .math-grid {
            display: grid;
            /* Columns set dynamically in JS */
            gap: 4px;
            font-family: 'Roboto Mono', monospace;
            font-size: 2rem;
            font-weight: bold;
            margin: 20px auto;
            width: 100%;
            justify-content: center;
            position: relative;
        }

        .header-cell {
            font-size: 0.8rem;
            color: #aaa;
            text-align: center;
            font-family: 'Fredoka';
            margin-bottom: 5px;
            letter-spacing: 1px;
        }

        .cell {
            height: 60px;
            width: 50px; /* Fixed width for cells */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            border-radius: 8px;
        }

        /* Special Elements */
        .carry-input {
            position: absolute;
            top: -20px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid var(--highlight);
            background: var(--bg-color);
            color: var(--highlight);
            text-align: center;
            font-size: 0.9rem;
            z-index: 10;
            line-height: 20px;
        }

        .borrow-strikethrough {
            position: absolute;
            width: 80%;
            height: 2px;
            background-color: var(--accent);
            transform: rotate(-45deg);
            top: 50%;
            left: 10%;
            display: none;
        }

        .borrow-val {
            position: absolute;
            top: -18px;
            left: -8px;
            font-size: 1.2rem;
            color: var(--accent);
            background: var(--bg-color);
            padding: 0 2px;
            border-radius: 4px;
            display: none;
            z-index: 5;
        }

        /* Animation Classes */
        .fly-up { animation: flyUpAnim 1s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes flyUpAnim {
            0% { transform: translateY(0) scale(1); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateY(-50px) scale(1.2); opacity: 1; }
        }

        .active-col {
            background-color: rgba(255, 255, 255, 0.15);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .operator { font-size: 1.8rem; color: var(--accent); display: flex; align-items: center; justify-content: center;}
        .divider { grid-column: 1 / -1; height: 3px; background: white; border-radius: 2px; margin-bottom: 5px; }

        /* Inputs */
        .user-input {
            width: 100%;
            height: 100%;
            background: #222;
            border: 1px solid #555;
            color: white;
            font-size: 1.5rem;
            text-align: center;
            border-radius: 8px;
            font-family: 'Roboto Mono';
        }
        .user-input:focus { outline: none; border-color: var(--neon-blue); background: #333; }
        .user-input.correct { border-color: #4caf50; background: rgba(76, 175, 80, 0.3); color: #a5d6a7; }
        .user-input.wrong { border-color: #f44336; background: rgba(244, 67, 54, 0.3); }

        /* Robot Area */
        .robot-area {
            display: flex;
            align-items: flex-start;
            gap: 15px;
            margin-top: 20px;
            min-height: 80px;
        }
        .robot-avatar { font-size: 2.5rem; animation: bounce 2s infinite; }
        .speech-box {
            background: white;
            color: #333;
            padding: 12px 20px;
            border-radius: 0 15px 15px 15px;
            position: relative;
            font-size: 1rem;
            line-height: 1.4;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            flex: 1;
        }
        .speech-box::before {
            content: ''; position: absolute; top: 0; left: -10px;
            border-width: 0 10px 10px 0; border-style: solid; border-color: transparent white transparent transparent;
        }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }

        /* Buttons */
        .action-bar { display: flex; justify-content: center; gap: 15px; margin-top: 25px; }
        .primary-btn {
            background: var(--neon-purple); color: white; border: none; padding: 12px 30px;
            font-size: 1.1rem; border-radius: 50px; cursor: pointer; font-family: 'Fredoka';
            box-shadow: 0 5px 15px rgba(114, 9, 183, 0.4);
        }
        .primary-btn:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(114, 9, 183, 0.6); }
        .primary-btn:active { transform: translateY(2px); }
        .primary-btn:disabled { background: #555; cursor: not-allowed; box-shadow: none; transform: none; }

        .secondary-btn {
            background: transparent; border: 2px solid white; color: white; padding: 10px 20px;
            border-radius: 10px; cursor: pointer; font-family: 'Fredoka'; font-size: 1rem;
        }

        .hidden { display: none; }
        .fade-in { animation: fade 0.5s; }
        @keyframes fade { from { opacity: 0; } to { opacity: 1; } }

        @media (max-width: 600px) {
            .cell { width: 35px; height: 50px; font-size: 1.5rem; }
            .header-cell { font-size: 0.6rem; }
            .user-input { font-size: 1.2rem; }
        }

    </style>
</head>
<body>

    <h1>üöÄ Space Math Academy: Challenge</h1>

    <div class="nav-container">
        <button class="nav-btn active" id="btn-learn" onclick="switchMode('learn')">üéì Training (Learn)</button>
        <button class="nav-btn" id="btn-practice" onclick="switchMode('practice')">‚≠ê Mission (Practice)</button>
    </div>

    <div class="main-panel">

        <div class="settings-bar">
            <div class="control-group">
                <span><strong>Op:</strong></span>
                <button class="toggle-btn selected" id="op-add" onclick="setOp('add')">+</button>
                <button class="toggle-btn" id="op-sub" onclick="setOp('sub')">‚àí</button>
            </div>
            <div class="control-group">
                <span><strong>Level:</strong></span>
                <button class="toggle-btn" id="dig-3" onclick="setDigits(3)">100s</button>
                <button class="toggle-btn selected" id="dig-4" onclick="setDigits(4)">1,000s</button>
                <button class="toggle-btn" id="dig-5" onclick="setDigits(5)">10,000s</button>
                <button class="toggle-btn" id="dig-6" onclick="setDigits(6)">100,000s</button>
            </div>
        </div>

        <div class="math-grid" id="grid-container">
            </div>

        <div class="robot-area">
            <div class="robot-avatar">ü§ñ</div>
            <div class="speech-box" id="robot-text">
                Welcome Cadet! Select a difficulty level and click <strong>"New Problem"</strong>.
            </div>
        </div>

        <div class="action-bar">
            <button class="secondary-btn" onclick="generateProblem()">üîÑ New Problem</button>
            <button class="primary-btn" id="main-action-btn" onclick="handleAction()">Start Lesson ‚û§</button>
        </div>

    </div>

    <script>
        // State Variables
        let appMode = 'learn';
        let operation = 'add';
        let numDigits = 4;

        let num1, num2, answer;
        let digits1, digits2, digitsAns;
        let colCount; // Total columns in grid (digits + 1 for operator)

        // Learn Mode specific
        let currentStep = 0;
        let carry = 0;

        // Place Value Headers map
        const placeValueHeaders = ['M', 'HTh', 'TTh', 'Th', 'H', 'T', 'O'];

        // Setup
        function switchMode(mode) {
            appMode = mode;
            document.getElementById('btn-learn').classList.toggle('active', mode === 'learn');
            document.getElementById('btn-practice').classList.toggle('active', mode === 'practice');

            // Update UI Text
            document.getElementById('main-action-btn').innerText = mode === 'learn' ? "Start Lesson ‚û§" : "Check Engines! ‚úì";

            generateProblem();
        }

        function setOp(op) {
            operation = op;
            document.getElementById('op-add').classList.toggle('selected', op === 'add');
            document.getElementById('op-sub').classList.toggle('selected', op === 'sub');
            generateProblem();
        }

        function setDigits(n) {
            numDigits = n;
            // Reset all digit buttons
            [3,4,5,6].forEach(d => document.getElementById(`dig-${d}`).classList.remove('selected'));
            document.getElementById(`dig-${n}`).classList.add('selected');
            generateProblem();
        }

        function generateProblem() {
            // 1. Generate Numbers based on difficulty
            let min = Math.pow(10, numDigits - 1); // e.g., 100, 1000, 10000
            let max = Math.pow(10, numDigits) - 1; // e.g., 999, 9999, 99999

            if (operation === 'add') {
                // Generate two large numbers
                num1 = Math.floor(Math.random() * (max - min)) + min;
                // Ensure num2 is substantial too
                num2 = Math.floor(Math.random() * (max - (min/2))) + (min/2);

                // Cap sum to not exceed digit count too wildly (optional, but keeps grid neat)
                // Let's allow carry over to next digit place
                answer = num1 + num2;
            } else {
                // Subtraction
                num1 = Math.floor(Math.random() * (max - min)) + min;
                // Ensure num2 is smaller but has enough digits to be challenging
                let max2 = num1 - 10;
                let min2 = Math.pow(10, Math.max(2, numDigits - 2)); // Ensure at least 2-3 digits subtracted
                num2 = Math.floor(Math.random() * (max2 - min2)) + min2;

                // Force a tricky borrow in random columns
                // (Optional: Logic to ensure borrows exist)
                answer = num1 - num2;
            }

            // 2. Prepare Arrays (padded)
            // We calculate grid width based on answer length (might be numDigits + 1)
            let gridWidth = Math.max(num1.toString().length, num2.toString().length, answer.toString().length);
            // Add 1 column for operator/spacing
            colCount = gridWidth + 1;

            digits1 = num1.toString().padStart(colCount, ' ').split('');
            digits2 = num2.toString().padStart(colCount, ' ').split('');
            digitsAns = answer.toString().padStart(colCount, ' ').split('');

            // 3. Render Grid
            renderGrid();

            // 4. Reset State
            currentStep = 0;
            carry = 0;

            // 5. Update Robot
            if (appMode === 'learn') {
                speak(`Challenge: <strong>${num1.toLocaleString()} ${operation==='add' ? '+' : '-'} ${num2.toLocaleString()}</strong>.<br>Click "Start Lesson" to see the solution.`);
                document.getElementById('main-action-btn').disabled = false;
                document.getElementById('main-action-btn').innerText = "Start Lesson ‚û§";
            } else {
                speak(`Mission: Solve <strong>${num1.toLocaleString()} ${operation==='add' ? '+' : '-'} ${num2.toLocaleString()}</strong>.<br>Enter your answer carefully!`);
                document.getElementById('main-action-btn').disabled = false;
                document.getElementById('main-action-btn').innerText = "Check Engines! ‚úì";
            }
        }

        function renderGrid() {
            const grid = document.getElementById('grid-container');
            grid.innerHTML = '';

            // Set grid columns dynamically
            grid.style.gridTemplateColumns = `repeat(${colCount}, 1fr)`;

            // Headers (Dynamic based on colCount)
            // We grab headers from the end of our master list
            // colCount includes spacer, so effective digits = colCount - 1 (usually)
            // If spacer is index 0

            // Spacer header
            grid.innerHTML += `<div class="header-cell"></div>`;

            // Digit headers
            let relevantHeaders = placeValueHeaders.slice(-(colCount-1));
            relevantHeaders.forEach(h => grid.innerHTML += `<div class="header-cell">${h}</div>`);

            // Row 1 (Top Number)
            digits1.forEach((d, i) => {
                let html = `<div class="cell top-row" id="top-${i}" data-val="${d}">`;

                // Visual elements for Borrowing
                html += `<div class="borrow-val" id="bval-${i}"></div>`;
                html += `<div class="borrow-strikethrough" id="strike-${i}"></div>`;

                // Carry bubbles
                // In Practice: inputs. In Learn: visual targets.
                // Only show carry bubble if it's a digit column (i > 0)
                if (i > 0) {
                    if (appMode === 'practice') {
                        html += `<input class="carry-input" type="text" maxlength="1" tabindex="-1">`;
                    } else {
                        html += `<div class="carry-input" id="carry-${i}" style="opacity:0; border:none;"></div>`;
                    }
                }

                html += `<span class="val">${d}</span></div>`;
                grid.innerHTML += html;
            });

            // Row 2 (Bottom Number) with Operator
            digits2.forEach((d, i) => {
                let content = d;
                if (i === 0) {
                    content = `<span class="operator">${operation === 'add' ? '+' : '-'}</span>`;
                    if(d !== ' ') content += `<span style="margin-left:5px">${d}</span>`;
                }
                grid.innerHTML += `<div class="cell" id="bot-${i}">${content}</div>`;
            });

            // Divider
            grid.innerHTML += `<div class="divider"></div>`;

            // Row 3 (Answer)
            digitsAns.forEach((d, i) => {
                let html = `<div class="cell ans-row" id="ans-${i}">`;
                if (appMode === 'learn') {
                    html += `<span class="val" style="opacity:0">${d}</span>`;
                } else {
                    // Inputs for practice
                    // Show input if there is a digit in any row at this column
                    let hasDigit = (digits1[i] !== ' ' || digits2[i] !== ' ' || digitsAns[i] !== ' ');
                    if (hasDigit && i > 0) {
                        html += `<input class="user-input" id="input-${i}" type="text" maxlength="1">`;
                    } else if (i === 0 && digitsAns[i] !== ' ') {
                        // Input for carry-over into new column
                        html += `<input class="user-input" id="input-${i}" type="text" maxlength="1">`;
                    }
                }
                html += `</div>`;
                grid.innerHTML += html;
            });
        }

        // --- ACTION HANDLER ---
        function handleAction() {
            if (appMode === 'learn') {
                runLearnStep();
            } else {
                checkPracticeAnswer();
            }
        }

        // --- LEARN MODE LOGIC ---
        function runLearnStep() {
            // Steps go from right (index colCount-1) to left (index 0)
            let col = (colCount - 1) - currentStep;

            // Check if finished
            // Finished if col < 0 OR (current column is empty space AND carry is 0)
            let isDone = false;
            if (col < 0) isDone = true;
            else if (digits1[col] === ' ' && digits2[col] === ' ' && carry === 0) isDone = true;

            if (isDone) {
                speak("Calculation Complete! Massive numbers, no problem! üåå");
                document.getElementById('main-action-btn').innerText = "Done";
                document.getElementById('main-action-btn').disabled = true;

                // Clear highlights
                document.querySelectorAll('.cell').forEach(c => c.classList.remove('active-col'));
                return;
            }

            // Highlight Column
            document.querySelectorAll('.cell').forEach(c => c.classList.remove('active-col'));
            let topCell = document.getElementById(`top-${col}`);
            let botCell = document.getElementById(`bot-${col}`);
            let ansCell = document.getElementById(`ans-${col}`);

            if(topCell) topCell.classList.add('active-col');
            if(botCell) botCell.classList.add('active-col');
            if(ansCell) ansCell.classList.add('active-col');

            document.getElementById('main-action-btn').innerText = "Next Step ‚û§";

            if (operation === 'add') {
                teachAddition(col);
            } else {
                teachSubtraction(col);
            }

            currentStep++;
        }

        function teachAddition(col) {
            let d1 = parseInt(digits1[col]) || 0;
            let d2 = parseInt(digits2[col]) || 0;
            let sum = d1 + d2 + carry;

            let txt = "";
            // Shorten text for speed in challenge mode
            txt = `Col ${placeValueHeaders[placeValueHeaders.length - (colCount - col)] || 'Val'}: `;

            if (carry > 0) txt += `${carry}(carry) + ${d1} + ${d2} = <strong>${sum}</strong>. `;
            else txt += `${d1} + ${d2} = <strong>${sum}</strong>. `;

            if (sum > 9) {
                let write = sum % 10;
                let newCarry = Math.floor(sum / 10);
                txt += `Write <strong>${write}</strong>, carry <strong>${newCarry}</strong>.`;

                // Visual Carry
                let carryBubble = document.getElementById(`carry-${col-1}`);
                if(carryBubble) {
                    carryBubble.innerText = newCarry;
                    carryBubble.style.border = "2px solid var(--highlight)";
                    carryBubble.style.background = "var(--bg-color)";
                    carryBubble.classList.add('fly-up');
                }
                carry = newCarry;
            } else {
                txt += `Write <strong>${sum}</strong>.`;
                carry = 0;
            }

            let ansSpan = document.getElementById(`ans-${col}`).querySelector('.val');
            if(ansSpan) {
                ansSpan.style.opacity = 1;
                ansSpan.classList.add('fade-in');
            }
            speak(txt);
        }

        function teachSubtraction(col) {
            // Get current visual value of top cell
            let topDom = document.getElementById(`top-${col}`);
            let borrowValDiv = topDom.querySelector('.borrow-val');
            let mainValDiv = topDom.querySelector('.val');

            let currentTop = borrowValDiv.style.display === 'block' ? parseInt(borrowValDiv.innerText) : parseInt(mainValDiv.innerText);
            if(isNaN(currentTop)) currentTop = 0;

            let d2 = parseInt(digits2[col]) || 0;
            let txt = "";

            if (currentTop >= d2) {
                txt = `${currentTop} - ${d2} = <strong>${currentTop - d2}</strong>.`;
            } else {
                // Borrow from Left
                let leftCol = col - 1;
                let leftDom = document.getElementById(`top-${leftCol}`);

                // Need to handle if left column is empty/zero (recursive borrowing not fully animated here for simplicity, assumes standard borrowing)
                // For teaching, we'll assume direct neighbor has value or is part of a chain.
                // Let's simplify: just show the borrow happening.

                let leftSpan = leftDom.querySelector('.val');
                let leftVal = parseInt(leftSpan.innerText);

                // Visual Borrow
                leftDom.querySelector('.borrow-strikethrough').style.display = 'block';
                leftDom.querySelector('.borrow-val').innerText = (leftVal - 1);
                leftDom.querySelector('.borrow-val').style.display = 'block';

                // Visual Add
                topDom.querySelector('.borrow-strikethrough').style.display = 'block';
                topDom.querySelector('.borrow-val').innerText = (currentTop + 10);
                topDom.querySelector('.borrow-val').style.display = 'block';

                txt = `Borrow from neighbor! ${leftVal} becomes ${leftVal-1}. ${currentTop} becomes ${currentTop+10}.<br>${currentTop+10} - ${d2} = <strong>${(currentTop+10)-d2}</strong>.`;
            }

            let ansSpan = document.getElementById(`ans-${col}`).querySelector('.val');
            if(ansSpan) {
                ansSpan.style.opacity = 1;
                ansSpan.classList.add('fade-in');
            }
            speak(txt);
        }

        // --- PRACTICE MODE LOGIC ---
        function checkPracticeAnswer() {
            let userAnsString = "";
            for(let i=0; i<colCount; i++) {
                let input = document.getElementById(`input-${i}`);
                if(input) {
                    let val = input.value.trim();
                    if(val === "") val = " ";
                    userAnsString += val;
                } else {
                    userAnsString += digitsAns[i];
                }
            }

            let cleanUser = userAnsString.replace(/\s/g, '');
            let cleanReal = answer.toString();

            if (cleanUser == cleanReal) {
                speak("üåü MISSION SUCCESS! Hyperspace jump activated! üåü");
                document.querySelectorAll('.user-input').forEach(i => i.classList.add('correct'));
            } else {
                speak("‚ö†Ô∏è Calculation Error! Check your columns and carries.");
                document.querySelectorAll('.user-input').forEach(i => {
                    let idx = i.id.split('-')[1];
                    if (i.value != digitsAns[idx]) i.classList.add('wrong');
                    else { i.classList.remove('wrong'); i.classList.add('correct'); }
                });
            }
        }

        function speak(html) {
            const box = document.getElementById('robot-text');
            box.style.opacity = 0;
            setTimeout(() => {
                box.innerHTML = html;
                box.style.opacity = 1;
            }, 200);
        }

        // Init
        generateProblem();

    </script>
</body>
</html>
