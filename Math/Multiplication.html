<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Fancy Multiplication Visualizations ‚Äî Improved</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --indigo-700:#4338ca; --indigo-600:#4f46e5; --slate-700:#334155; --slate-600:#475569; --slate-500:#64748b; --violet-500:#8b5cf6; --violet-600:#7c3aed; --blue-700:#1d4ed8; --emerald-600:#059669; --rose-500:#f43f5e;
    }
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif; background: linear-gradient(to bottom, #eef2ff, #f3e8ff); min-height: 100vh; padding: 2rem; color: #111827; }
    .container { max-width: 1100px; margin: 0 auto; }
    h1 { font-size: 2.25rem; font-weight: 800; text-align: center; color: #312e81; margin-bottom: .5rem; letter-spacing: .2px; }
    .subtitle { text-align: center; color: #4b5563; margin-bottom: 1.25rem; }
    .panel { background: #fff; border-radius: 12px; box-shadow: 0 12px 24px rgba(0,0,0,.08); border: 1px solid #e5e7eb; }
    .viz-buttons { display: grid; grid-template-columns: repeat(auto-fit,minmax(120px,1fr)); gap: .5rem; margin-bottom: 1rem; }
    .viz-btn { background: #fff; color: #374151; border: 2px solid #e5e7eb; padding: .75rem 1rem; border-radius: 10px; font-weight: 700; cursor: pointer; transition: .2s ease; }
    .viz-btn:hover { border-color: var(--indigo-600); transform: translateY(-1px); }
    .viz-btn.active { background: var(--indigo-600); color: #fff; box-shadow: 0 10px 18px rgba(79,70,229,.28); transform: translateY(-1px) scale(1.02); }
    .controls { display: grid; grid-template-columns: repeat(auto-fit,minmax(280px,1fr)); gap: 1rem; padding: 1rem; }
    .control-group { padding: 1rem; border: 1px dashed #e5e7eb; border-radius: 10px; }
    .control-group label { display:block; font-size:.9rem; font-weight:700; color:#374151; margin-bottom:.5rem; }
    .number-display { font-size: 1.875rem; color: var(--indigo-600); font-weight: 800; }
    .number-buttons { display:flex; gap:.4rem; flex-wrap:wrap; margin-top:.6rem; }
    .number-btn { padding:.45rem .7rem; background:#f3f4f6; color:#374151; border:2px solid transparent; border-radius: 9px; cursor:pointer; font-weight:700; transition:.15s ease; min-width: 2.2rem; text-align:center; }
    .number-btn:hover { background:#e5e7eb; }
    .number-btn.active { background: var(--indigo-600); color:#fff; }
    .extras { display:flex; gap:.5rem; margin-top:.6rem; flex-wrap:wrap; }
    .chip { padding:.45rem .7rem; border-radius: 9999px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; font-weight:700; }
    .visualization { padding: 1.2rem; }
    .visualization-content { padding: 1.2rem; }
    .hidden { display:none; }
    .center-text { text-align:center; color:#4b5563; margin-bottom: .8rem; }
    .grid-display { display:flex; flex-direction:column; gap:.4rem; align-items:center; }
    .grid-row { display:flex; gap:.4rem; }
    .grid-item { width:40px; height:40px; background: linear-gradient(135deg, #60a5fa, #1e40af); border-radius: .6rem; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:800; font-size:.875rem; box-shadow: 0 2px 4px rgba(0,0,0,.08); }
    .circles-display { display:flex; flex-wrap:wrap; gap:1.2rem; justify-content:center; }
    .group { text-align:center; }
    .group-label { font-size:.85rem; font-weight:700; color:#6b7280; margin-bottom:.35rem; }
    .circles { display:flex; flex-wrap:wrap; gap:.45rem; justify-content:center; width: 172px; }
    .circle { width:30px; height:30px; background: linear-gradient(135deg, #c084fc, #7c3aed); border-radius:50%; box-shadow: 0 2px 4px rgba(0,0,0,.08); }
    .result-box { text-align:center; margin-top: 1rem; padding: .9rem; border-radius: .8rem; }
    .result-green { background:#dcfce7; } .result-green p { color:#166534; }
    .result-blue { background:#dbeafe; } .result-blue p { color:#1e40af; }
    .result-purple { background:#f3e8ff; } .result-purple p { color:#6b21a8; }
    .result-orange { background:#fed7aa; } .result-orange p { color:#7c2d12; }
    .result-pink { background:#fbcfe8; } .result-pink p { color:#831843; }
    .result-box p { font-size: 1.6rem; font-weight: 900; letter-spacing: .3px; }
    .small-text { font-size: .85rem; margin-top:.3rem; color:#475569; }
    .helper { display:flex; justify-content:space-between; align-items:center; gap:1rem; padding: .8rem 1rem; border-top:1px solid #eef2ff; color:#475569; font-size:.93rem; }
    .helper span strong { color: var(--indigo-700); }
    .helper .right { display:flex; gap:.5rem; align-items:center; }
    .pill { padding:.25rem .6rem; background:#eef2ff; border-radius: 9999px; font-weight:700; color:#3730a3; border:1px solid #e0e7ff; }
    .linkish { border:none; background:none; color: var(--blue-700); font-weight:700; cursor:pointer; text-decoration: underline; }
    svg { max-width: 100%; height: auto; }
    .practice-container { text-align: center; }
    .practice-question { font-size: 2rem; font-weight: 900; color: #312e81; margin: 1rem 0; }
    .practice-question span { font-size: 2.5rem; color: var(--indigo-600); }
    .practice-input-group { display: flex; gap: .8rem; justify-content: center; align-items: center; margin: 1.5rem 0; flex-wrap: wrap; }
    .practice-input { padding: .75rem 1rem; font-size: 1.5rem; border: 2px solid #e5e7eb; border-radius: 8px; width: 120px; text-align: center; font-weight: 700; }
    .practice-input:focus { outline: none; border-color: var(--indigo-600); box-shadow: 0 0 0 3px rgba(79,70,229,.1); }
    .practice-btn { padding: .75rem 1.5rem; background: var(--indigo-600); color: #fff; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-size: 1rem; transition: .2s ease; }
    .practice-btn:hover { background: var(--indigo-700); transform: translateY(-1px); }
    .practice-btn:active { transform: translateY(0); }
    .practice-feedback { margin: 1.5rem 0; padding: 1rem; border-radius: 8px; font-size: 1.1rem; font-weight: 700; min-height: 2rem; }
    .feedback-correct { background: #dcfce7; color: #166534; }
    .feedback-incorrect { background: #fee2e2; color: #991b1b; }
    .feedback-hidden { visibility: hidden; }
    .practice-streak { font-size: 1.3rem; color: var(--indigo-700); font-weight: 800; margin: 1rem 0; }
    .practice-controls { display: flex; gap: .5rem; justify-content: center; margin-top: 1.5rem; flex-wrap: wrap; }
    .difficulty-btn { padding: .5rem 1rem; background: #f3f4f6; border: 2px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-weight: 700; transition: .2s ease; }
    .difficulty-btn.active { background: var(--indigo-600); color: #fff; border-color: var(--indigo-600); }
    .difficulty-btn:hover { border-color: var(--indigo-600); }
    .factorization-container { padding: 1.5rem; }
    .factorization-input-group { text-align: center; margin-bottom: 2rem; }
    .factorization-input-group label { display: block; font-weight: 700; color: #374151; margin-bottom: .5rem; }
    .factorization-input-group input { margin: 0 .5rem; }
    .factorization-result { margin-top: 2rem; }
    .factor-display { text-align: center; margin: 1.5rem 0; }
    .all-factors { display: flex; flex-wrap: wrap; gap: .5rem; justify-content: center; margin: 1rem 0; }
    .factor-chip { background: linear-gradient(135deg, #4f46e5, #7c3aed); color: #fff; padding: .6rem 1rem; border-radius: 20px; font-weight: 700; font-size: 1rem; }
    .factor-pairs { margin: 1.5rem 0; }
    .factor-pairs-title { font-size: 1.1rem; font-weight: 700; color: #312e81; text-align: center; margin-bottom: 1rem; }
    .pair-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
    .pair-card { background: linear-gradient(135deg, #dbeafe, #e0e7ff); border: 2px solid #4f46e5; border-radius: 10px; padding: 1rem; text-align: center; }
    .pair-card strong { font-size: 1.3rem; color: #4f46e5; }
    .pair-card p { color: #475569; margin-top: .3rem; font-size: .9rem; }
    .factor-error { text-align: center; color: #991b1b; font-weight: 700; padding: 1rem; background: #fee2e2; border-radius: 8px; }
    .properties-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.5rem; margin: 1rem 0; }
    .property-card { background: linear-gradient(135deg, #fef3c7, #fde68a); border: 2px solid #f59e0b; border-radius: 12px; padding: 1.5rem; }
    .property-card h3 { color: #92400e; margin-bottom: .5rem; font-size: 1.1rem; }
    .property-card p { color: #78350f; margin: .5rem 0; line-height: 1.6; }
    .property-example { background: rgba(255,255,255,0.7); padding: .75rem; border-radius: 6px; margin-top: .5rem; font-family: monospace; font-weight: 700; }
    .zero-demo { text-align: center; padding: 2rem; }
    .zero-visual { display: flex; gap: 1rem; justify-content: center; align-items: center; margin: 1.5rem 0; flex-wrap: wrap; }
    .zero-box { background: linear-gradient(135deg, #fecaca, #fca5a5); border: 3px dashed #dc2626; border-radius: 8px; padding: 1rem; min-width: 100px; text-align: center; }
    .zero-box p { font-weight: 700; color: #991b1b; margin: .25rem 0; }
    .equals-sign { font-size: 1.5rem; font-weight: 900; color: #333; }
    .realworld-container { padding: 1rem; }
    .scenario-card { background: linear-gradient(135deg, #d1fae5, #a7f3d0); border: 2px solid #059669; border-radius: 12px; padding: 1.5rem; margin: 1rem 0; }
    .scenario-card h3 { color: #065f46; margin-bottom: 1rem; font-size: 1.2rem; }
    .scenario-content { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
    .scenario-item { background: rgba(255,255,255,0.8); padding: 1rem; border-radius: 8px; }
    .scenario-item strong { color: #059669; display: block; margin-bottom: .3rem; }
    .scenario-item p { color: #475569; font-size: .9rem; line-height: 1.5; }
    .visual-example { text-align: center; margin: 1rem 0; }
    .visual-example img { max-width: 100%; height: auto; }
  </style>
</head>
<body>
  <div class="container">
    <h1>Fancy Multiplication Visualizations</h1>
    <p class="subtitle">Multiple ways to <em>see</em> multiplication! (Commutative: <strong>a √ó b = b √ó a</strong>)</p>

    <!-- Tabs -->
    <div class="viz-buttons">
      <button class="viz-btn" data-viz="grid">Grid</button>
      <button class="viz-btn" data-viz="area">Area</button>
      <button class="viz-btn" data-viz="circles">Groups</button>
      <button class="viz-btn" data-viz="numberline">Number Line</button>
      <button class="viz-btn" data-viz="tree">Tree</button>
      <button class="viz-btn" data-viz="practice">Practice</button>
      <button class="viz-btn" data-viz="factorization">Factors</button>
      <button class="viz-btn" data-viz="properties">Properties</button>
      <button class="viz-btn" data-viz="realworld">Real World</button>
    </div>

    <!-- Controls -->
    <div class="panel controls" id="controlsPanel">
      <div class="control-group">
        <label>First Number: <span class="number-display" id="num1Display">‚Äî</span></label>
        <div id="num1Btns" class="number-buttons"></div>
        <div class="extras">
          <button id="swapBtn" class="chip" title="Swap factors">Swap a‚Üîb</button>
          <button id="randomBtn" class="chip" title="Random small practice pair">Random</button>
        </div>
      </div>
      <div class="control-group">
        <label>Second Number: <span class="number-display" id="num2Display">‚Äî</span></label>
        <div id="num2Btns" class="number-buttons"></div>
        <div class="small-text">Choose 1‚Äì12 (like a times table!)</div>
      </div>
    </div>

    <!-- Visualization Display -->
    <div class="panel visualization" aria-live="polite">
      <div id="grid" class="visualization-content hidden">
        <p class="center-text" id="gridText"></p>
        <div class="grid-display" id="gridContent"></div>
        <div class="result-box result-green"><p id="gridResult"></p></div>
      </div>

      <div id="area" class="visualization-content hidden">
        <p class="center-text">Area Model: width √ó height = area</p>
        <svg id="areaSvg"></svg>
        <div class="result-box result-blue">
          <p id="areaResult"></p>
          <div class="small-text" id="areaNote"></div>
        </div>
      </div>

      <div id="circles" class="visualization-content hidden">
        <p class="center-text" id="circlesText"></p>
        <div class="circles-display" id="circlesContent"></div>
        <div class="result-box result-purple"><p id="circlesResult"></p></div>
      </div>

      <div id="numberline" class="visualization-content hidden">
        <p class="center-text" id="nlText"></p>
        <svg id="numberlineSvg" viewBox="0 0 800 180"></svg>
        <div class="result-box result-orange">
          <p id="numberlineResult"></p>
          <div class="small-text" id="numberlineNote"></div>
        </div>
      </div>

      <div id="tree" class="visualization-content hidden">
        <p class="center-text" id="treeText"></p>
        <svg id="treeSvg" viewBox="0 0 460 380" preserveAspectRatio="xMidYMid meet" style="overflow:visible;"></svg>
        <div class="result-box result-pink"><p id="treeResult"></p><div class="small-text">Repeated addition view</div></div>
      </div>

      <div id="practice" class="visualization-content hidden">
        <div class="practice-container">
          <div class="practice-controls">
            <span style="color: #475569; font-weight: 700;">Difficulty:</span>
            <button class="difficulty-btn active" data-difficulty="easy">Easy (1-6)</button>
            <button class="difficulty-btn" data-difficulty="medium">Medium (1-9)</button>
            <button class="difficulty-btn" data-difficulty="hard">Hard (1-12)</button>
          </div>
          <div class="practice-streak" id="practiceStreak">Streak: 0</div>
          <div class="practice-question">
            <span id="factor1">?</span> √ó <span id="factor2">?</span> = ?
          </div>
          <div class="practice-input-group">
            <input type="number" class="practice-input" id="practiceAnswer" placeholder="Your answer" min="1" />
            <button class="practice-btn" id="checkBtn">Check</button>
          </div>
          <div class="practice-feedback feedback-hidden" id="practiceFeedback"></div>
          <button class="chip" id="skipBtn" title="Skip this problem">Skip</button>
          <button class="chip" id="showBtn" title="Reveal answer">Show Answer</button>
        </div>
      </div>

      <div id="factorization" class="visualization-content hidden">
        <p class="center-text"><strong>Find all the factors and factor pairs!</strong></p>
        <div class="factorization-container">
          <div class="factorization-input-group">
            <label>Enter a number (1‚Äì144):</label>
            <input type="number" id="factorInput" class="practice-input" min="1" max="144" placeholder="e.g., 12" />
            <button class="practice-btn" id="factorBtn">Find Factors</button>
          </div>
          <div class="factorization-result" id="factorResult"></div>
        </div>
      </div>

      <div id="properties" class="visualization-content hidden">
        <p class="center-text"><strong style="font-size: 1.3rem;">Multiplication Properties</strong></p>
        <div class="properties-grid">
          <div class="property-card">
            <h3>üîÑ Commutative Property</h3>
            <p>Order doesn't matter! You get the same answer either way.</p>
            <div class="property-example">3 √ó 4 = 12<br>4 √ó 3 = 12</div>
            <p style="margin-top: 1rem; font-size: 0.9rem;">üí° Think: 3 bags of 4 apples = 4 rows of 3 boxes</p>
          </div>

          <div class="property-card">
            <h3>üéØ Identity Property</h3>
            <p>Multiply by 1, and the number stays the same.</p>
            <div class="property-example">7 √ó 1 = 7<br>1 √ó 100 = 100</div>
            <p style="margin-top: 1rem; font-size: 0.9rem;">üí° Think: 1 group of 7 = 7</p>
          </div>

          <div class="property-card">
            <h3>üö´ Zero Property</h3>
            <p>Multiply by 0, and you always get 0.</p>
            <div class="property-example">5 √ó 0 = 0<br>0 √ó 1000 = 0</div>
            <p style="margin-top: 1rem; font-size: 0.9rem;">üí° Think: 0 groups = nothing!</p>
          </div>
        </div>

        <div style="margin-top: 2rem; text-align: center;">
          <h3 style="color: #312e81; margin-bottom: 1rem;">Try the Zero Property</h3>
          <div class="zero-demo">
            <div class="zero-visual">
              <div style="text-align: center;">
                <p style="color: #475569; font-weight: 700; margin-bottom: 0.5rem;">0 groups of 5</p>
                <div class="zero-box" style="height: 60px; display: flex; align-items: center; justify-content: center;">
                  <p style="font-size: 1.5rem;">‚àÖ</p>
                </div>
              </div>
              <div class="equals-sign">=</div>
              <div style="text-align: center;">
                <p style="color: #475569; font-weight: 700; margin-bottom: 0.5rem;">Result</p>
                <div style="background: linear-gradient(135deg, #d4d4d8, #a1a1a1); border: 3px solid #18181b; border-radius: 8px; padding: 1rem; min-width: 100px;">
                  <p style="font-size: 2rem; font-weight: 900; color: #fff;">0</p>
                </div>
              </div>
            </div>
            <p style="color: #475569; margin-top: 1rem; font-size: 1rem;">No matter what you multiply by 0, you always get 0!</p>
          </div>
        </div>
      </div>

      <div id="realworld" class="visualization-content hidden">
        <p class="center-text"><strong style="font-size: 1.3rem;">Multiplication in Real Life</strong></p>
        <div class="realworld-container">
          <div class="scenario-card">
            <h3>üçé Buying Apples</h3>
            <div class="scenario-content">
              <div class="scenario-item">
                <strong>The Problem:</strong>
                <p>You buy 4 baskets with 6 apples in each. How many apples total?</p>
              </div>
              <div class="scenario-item">
                <strong>The Math:</strong>
                <p style="font-size: 1.1rem; color: #059669; font-weight: 700;">4 √ó 6 = 24</p>
                <p>4 baskets √ó 6 apples = 24 apples!</p>
              </div>
            </div>
          </div>

          <div class="scenario-card">
            <h3>üéÅ Packing Boxes</h3>
            <div class="scenario-content">
              <div class="scenario-item">
                <strong>The Problem:</strong>
                <p>You have 3 boxes and put 8 toys in each box. How many toys total?</p>
              </div>
              <div class="scenario-item">
                <strong>The Math:</strong>
                <p style="font-size: 1.1rem; color: #059669; font-weight: 700;">3 √ó 8 = 24</p>
                <p>3 boxes √ó 8 toys = 24 toys!</p>
              </div>
            </div>
          </div>

          <div class="scenario-card">
            <h3>üí∞ Counting Money</h3>
            <div class="scenario-content">
              <div class="scenario-item">
                <strong>The Problem:</strong>
                <p>You have 5 coins worth 10¬¢ each. How much money?</p>
              </div>
              <div class="scenario-item">
                <strong>The Math:</strong>
                <p style="font-size: 1.1rem; color: #059669; font-weight: 700;">5 √ó 10¬¢ = 50¬¢</p>
                <p>5 coins √ó 10¬¢ each = 50¬¢ total!</p>
              </div>
            </div>
          </div>

          <div class="scenario-card">
            <h3>üìê Room Area</h3>
            <div class="scenario-content">
              <div class="scenario-item">
                <strong>The Problem:</strong>
                <p>Your room is 7 feet wide and 9 feet long. What's the area?</p>
              </div>
              <div class="scenario-item">
                <strong>The Math:</strong>
                <p style="font-size: 1.1rem; color: #059669; font-weight: 700;">7 √ó 9 = 63</p>
                <p>7 ft √ó 9 ft = 63 square feet!</p>
              </div>
            </div>
          </div>

          <div class="scenario-card">
            <h3>üçï Pizza Party</h3>
            <div class="scenario-content">
              <div class="scenario-item">
                <strong>The Problem:</strong>
                <p>You order 6 pizzas with 8 slices each. How many slices?</p>
              </div>
              <div class="scenario-item">
                <strong>The Math:</strong>
                <p style="font-size: 1.1rem; color: #059669; font-weight: 700;">6 √ó 8 = 48</p>
                <p>6 pizzas √ó 8 slices = 48 slices total!</p>
              </div>
            </div>
          </div>

          <div class="scenario-card">
            <h3>‚è∞ Time & Patterns</h3>
            <div class="scenario-content">
              <div class="scenario-item">
                <strong>The Problem:</strong>
                <p>If a video is 4 minutes long and you watch it 5 times, how many minutes?</p>
              </div>
              <div class="scenario-item">
                <strong>The Math:</strong>
                <p style="font-size: 1.1rem; color: #059669; font-weight: 700;">4 √ó 5 = 20</p>
                <p>4 minutes √ó 5 times = 20 minutes total!</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="helper" id="helperRow">
        <span>Result: <strong id="resultBig">‚Äî</strong></span>
        <div class="right"><span class="pill" id="identityHint">Identity: 1 √ó n = n</span><button class="linkish" id="commHint">Why a√ób = b√óa?</button></div>
      </div>
    </div>
  </div>

  <script>
    let num1 = 3, num2 = 4, currentViz = 'grid';
    let practiceStreak = 0, practiceDifficulty = 'easy';

    function buildButtons(containerId, clickFn, activeVal) {
      const c = document.getElementById(containerId); c.innerHTML = '';
      for (let n = 1; n <= 12; n++) {
        const b = document.createElement('button');
        b.className = 'number-btn' + (n === activeVal ? ' active' : '');
        b.textContent = n; b.setAttribute('data-n', n);
        b.addEventListener('click', () => clickFn(n));
        c.appendChild(b);
      }
    }

    function setActiveTab(target) {
      document.querySelectorAll('.viz-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.viz === target);
      });
      document.querySelectorAll('.visualization-content').forEach(el => el.classList.add('hidden'));
      document.getElementById(target).classList.remove('hidden');
      document.getElementById('controlsPanel').style.display = target === 'practice' || target === 'factorization' || target === 'properties' || target === 'realworld' ? 'none' : 'grid';
      document.getElementById('helperRow').style.display = target === 'practice' || target === 'factorization' || target === 'properties' || target === 'realworld' ? 'none' : 'flex';
      currentViz = target;
      if (target === 'practice') generatePracticeQuestion();
      else if (target !== 'factorization' && target !== 'properties' && target !== 'realworld') updateVisualization();
    }

    document.querySelectorAll('.viz-btn').forEach(btn => {
      btn.addEventListener('click', () => setActiveTab(btn.dataset.viz));
    });

    function setNum1(n) { num1 = n; syncButtons('num1Btns', n); updateVisualization(); }
    function setNum2(n) { num2 = n; syncButtons('num2Btns', n); updateVisualization(); }

    function syncButtons(containerId, activeVal) {
      document.querySelectorAll(`#${containerId} .number-btn`).forEach(b => {
        b.classList.toggle('active', Number(b.dataset.n) === activeVal);
      });
      document.getElementById('num1Display').textContent = num1;
      document.getElementById('num2Display').textContent = num2;
    }

    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));

    function playSuccessSound() {
      const audioContext = new (window.AudioContext || window.webkitAudioContext)();
      const notes = [523.25, 659.25, 783.99];
      const startTime = audioContext.currentTime;
      notes.forEach((freq, idx) => {
        const osc = audioContext.createOscillator();
        const gain = audioContext.createGain();
        osc.connect(gain);
        gain.connect(audioContext.destination);
        osc.frequency.value = freq;
        osc.type = 'sine';
        gain.gain.setValueAtTime(0.3, startTime);
        gain.gain.exponentialRampToValueAtTime(0.01, startTime + 0.5);
        osc.start(startTime);
        osc.stop(startTime + 0.5);
      });
    }

    function generatePracticeQuestion() {
      const max = practiceDifficulty === 'easy' ? 6 : practiceDifficulty === 'medium' ? 9 : 12;
      num1 = 1 + Math.floor(Math.random() * max);
      num2 = 1 + Math.floor(Math.random() * max);
      document.getElementById('factor1').textContent = num1;
      document.getElementById('factor2').textContent = num2;
      document.getElementById('practiceAnswer').value = '';
      document.getElementById('practiceAnswer').focus();
      document.getElementById('practiceFeedback').classList.add('feedback-hidden');
      document.getElementById('practiceFeedback').textContent = '';
    }

    function checkPracticeAnswer() {
      const answer = parseInt(document.getElementById('practiceAnswer').value, 10);
      const correct = num1 * num2;
      const fb = document.getElementById('practiceFeedback');
      fb.classList.remove('feedback-hidden');
      if (answer === correct) {
        playSuccessSound();
        practiceStreak++;
        fb.className = 'practice-feedback feedback-correct';
        fb.textContent = 'üéâ Correct! Great job!';
        document.getElementById('practiceStreak').textContent = `Streak: ${practiceStreak}`;
        setTimeout(() => generatePracticeQuestion(), 1500);
      } else {
        practiceStreak = 0;
        fb.className = 'practice-feedback feedback-incorrect';
        fb.textContent = `Not quite. ${num1} √ó ${num2} = ${correct}. Try again!`;
        document.getElementById('practiceStreak').textContent = `Streak: ${practiceStreak}`;
      }
    }

    document.getElementById('checkBtn').addEventListener('click', checkPracticeAnswer);
    document.getElementById('practiceAnswer').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') checkPracticeAnswer();
    });

    document.getElementById('skipBtn').addEventListener('click', generatePracticeQuestion);
    document.getElementById('showBtn').addEventListener('click', () => {
      const correct = num1 * num2;
      const fb = document.getElementById('practiceFeedback');
      fb.classList.remove('feedback-hidden');
      fb.className = 'practice-feedback feedback-correct';
      fb.textContent = `Answer: ${num1} √ó ${num2} = ${correct}`;
    });

    document.querySelectorAll('.difficulty-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        practiceDifficulty = btn.dataset.difficulty;
        practiceStreak = 0;
        document.getElementById('practiceStreak').textContent = 'Streak: 0';
        generatePracticeQuestion();
      });
    });

    function getFactors(n) {
      const factors = [];
      for (let i = 1; i <= n; i++) {
        if (n % i === 0) factors.push(i);
      }
      return factors;
    }

    function getFactorPairs(n) {
      const pairs = [];
      for (let i = 1; i <= Math.sqrt(n); i++) {
        if (n % i === 0) {
          pairs.push({ a: i, b: n / i });
        }
      }
      return pairs;
    }

    function displayFactorization() {
      const input = parseInt(document.getElementById('factorInput').value, 10);
      const resultDiv = document.getElementById('factorResult');
      
      if (isNaN(input) || input < 1 || input > 144) {
        resultDiv.innerHTML = '<div class="factor-error">Please enter a number between 1 and 144.</div>';
        return;
      }

      const factors = getFactors(input);
      const pairs = getFactorPairs(input);

      let html = `<div class="factor-display">
        <p style="font-size: 1.2rem; color: #475569; margin-bottom: 1rem;"><strong style="font-size: 1.5rem; color: #4f46e5;">${input}</strong> has the following factors:</p>
        <div class="all-factors">`;
      
      factors.forEach(f => {
        html += `<span class="factor-chip">${f}</span>`;
      });

      html += `</div></div>
        <div class="factor-pairs">
          <div class="factor-pairs-title">Factor Pairs (ways to multiply to get ${input}):</div>
          <div class="pair-grid">`;

      pairs.forEach(pair => {
        html += `<div class="pair-card">
          <strong>${pair.a} √ó ${pair.b}</strong>
          <p>= ${input}</p>
        </div>`;
      });

      html += `</div></div>`;
      resultDiv.innerHTML = html;
    }

    document.getElementById('factorBtn').addEventListener('click', displayFactorization);
    document.getElementById('factorInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') displayFactorization();
    });

    function updateVisualization() {
      const product = num1 * num2;
      document.getElementById('resultBig').textContent = `${num1} √ó ${num2} = ${product}`;
      document.getElementById('identityHint').style.display = (num1===1||num2===1)?'inline-block':'none';

      if (currentViz === 'grid') renderGrid(product);
      else if (currentViz === 'area') renderArea(product);
      else if (currentViz === 'circles') renderCircles(product);
      else if (currentViz === 'numberline') renderNumberLine(product);
      else if (currentViz === 'tree') renderTree(product);
    }

    function renderGrid(product) {
      const gridText = document.getElementById('gridText');
      gridText.innerHTML = `${num1} rows √ó ${num2} columns = <strong style="font-size:1.5rem;color:#16a34a;">${product}</strong>`;

      const grid = document.getElementById('gridContent'); grid.innerHTML='';
      const maxCells = 144;
      const rows = clamp(num1,1,12), cols = clamp(num2,1,12);
      let counter = 1;
      for (let r=0;r<rows;r++){
        const row = document.createElement('div'); row.className='grid-row';
        for (let c=0;c<cols;c++){
          if (counter>maxCells) break;
          const cell = document.createElement('div'); cell.className='grid-item';
          cell.textContent = counter++; row.appendChild(cell);
        }
        grid.appendChild(row);
      }
      document.getElementById('gridResult').textContent = `${num1} √ó ${num2} = ${product}`;
    }

    function renderArea(product) {
      const svg = document.getElementById('areaSvg'); svg.innerHTML='';
      const unit = 32; const width = clamp(num2,1,20)*unit, height = clamp(num1,1,20)*unit;
      const pad = 40; svg.setAttribute('viewBox',`0 0 ${width+pad*2} ${height+pad*2}`);

      const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
      rect.setAttribute('x', pad); rect.setAttribute('y', pad);
      rect.setAttribute('width', width); rect.setAttribute('height', height);
      rect.setAttribute('fill', '#dbeafe'); rect.setAttribute('stroke', '#0284c7'); rect.setAttribute('stroke-width','3');
      svg.appendChild(rect);

      for (let i=1;i<num1;i++) addLine(pad, pad+i*unit, pad+width, pad+i*unit);
      for (let j=1;j<num2;j++) addLine(pad+j*unit, pad, pad+j*unit, pad+height);
      function addLine(x1,y1,x2,y2){ const l=document.createElementNS('http://www.w3.org/2000/svg','line'); l.setAttribute('x1',x1); l.setAttribute('y1',y1); l.setAttribute('x2',x2); l.setAttribute('y2',y2); l.setAttribute('stroke','#cbd5e1'); l.setAttribute('stroke-width','1'); l.setAttribute('stroke-dasharray','4'); svg.appendChild(l);}    

      const lblTop = textAt(pad+width/2, pad-12, num2, 16, '#1e40af');
      const lblLeft = textAt(pad-12, pad+height/2, num1, 16, '#1e40af'); lblLeft.setAttribute('text-anchor','end'); lblLeft.setAttribute('dominant-baseline','middle');
      const lblCenter = textAt(pad+width/2, pad+height/2, product, 18, '#1e3a8a'); lblCenter.setAttribute('dominant-baseline','middle');
      function textAt(x,y,txt,size,fill){ const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',x); t.setAttribute('y',y); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size',size); t.setAttribute('font-weight','800'); t.setAttribute('fill',fill); t.textContent=txt; svg.appendChild(t); return t; }

      document.getElementById('areaResult').textContent = `${num1} √ó ${num2} = ${product}`;
      document.getElementById('areaNote').textContent = `The blue rectangle covers ${product} square units.`;
    }

    function renderCircles(product) {
      const txt = document.getElementById('circlesText');
      txt.innerHTML = `${num1} groups of ${num2} = <strong style="font-size:1.4rem;color:#7c3aed;">${product}</strong>`;
      const wrap = document.getElementById('circlesContent'); wrap.innerHTML='';
      const groups = clamp(num1,1,12), per = clamp(num2,1,24);
      for (let g=0; g<groups; g++){
        const group = document.createElement('div'); group.className='group';
        const label = document.createElement('p'); label.className='group-label'; label.textContent = `Group ${g+1}`; group.appendChild(label);
        const row = document.createElement('div'); row.className='circles';
        for (let i=0;i<per;i++){ const dot=document.createElement('div'); dot.className='circle'; row.appendChild(dot);} 
        group.appendChild(row); wrap.appendChild(group);
      }
      document.getElementById('circlesResult').textContent = `${num1} √ó ${num2} = ${product}`;
    }

    function renderNumberLine(product) {
      const svg = document.getElementById('numberlineSvg'); svg.innerHTML='';
      const maxP = Math.min(product, 120);
      const padL = 30, padR = 30, baseY = 100, unit = 6;
      const width = padL + maxP*unit + padR; svg.setAttribute('viewBox',`0 0 ${Math.max(width, 260)} 180`);

      addLine(padL, baseY, padL + maxP*unit, baseY, '#334155', 2);
      for (let i=0;i<=maxP;i++){
        const x = padL + i*unit; const h = (i%num2===0)?10:6; addLine(x, baseY-h/2, x, baseY+h/2, '#334155', (i%num2===0)?2:1);
        if (i%num2===0){ addText(x, baseY+20, i.toString(), 11, '#334155'); }
      }
      for (let j=0;j<num1;j++){
        const start = padL + j*num2*unit; const end = padL + (j+1)*num2*unit; const ctrlY = baseY - 30 - j*10;
        const path = document.createElementNS('http://www.w3.org/2000/svg','path');
        path.setAttribute('d', `M ${start} ${baseY} Q ${(start+end)/2} ${ctrlY} ${end} ${baseY}`);
        path.setAttribute('fill','none'); path.setAttribute('stroke', ['#ef4444','#3b82f6','#10b981','#f59e0b','#8b5cf6'][j%5]); path.setAttribute('stroke-width','2');
        svg.appendChild(path);
        addText((start+end)/2, ctrlY-8, `+${num2}`, 12, '#0f172a');
      }

      document.getElementById('nlText').textContent = `Skip counting by ${num2}, ${num1} times`;
      document.getElementById('numberlineResult').textContent = `${num1} √ó ${num2} = ${product}`;
      document.getElementById('numberlineNote').textContent = `0 ${Array(num1).fill(`+ ${num2}`).join(' ')} = ${product}`;

      function addLine(x1,y1,x2,y2,stroke,w){ const l=document.createElementNS('http://www.w3.org/2000/svg','line'); l.setAttribute('x1',x1); l.setAttribute('y1',y1); l.setAttribute('x2',x2); l.setAttribute('y2',y2); l.setAttribute('stroke',stroke); l.setAttribute('stroke-width',w); svg.appendChild(l); }
      function addText(x,y,txt,size,fill){ const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',x); t.setAttribute('y',y); t.setAttribute('text-anchor','middle'); t.setAttribute('font-size',size); t.setAttribute('font-weight','800'); t.setAttribute('fill',fill); svg.appendChild(t); t.textContent = txt; }
    }

    function renderTree(product) {
      const svg = document.getElementById('treeSvg'); svg.innerHTML='';
      const cx=230, cy=220, r=26;
      circle(cx,cy,r,'#ec4899'); text(cx, cy+1, product, 16, '#fff');
      for (let i=0;i<num1;i++){
        const angle = (Math.PI/(num1+1))*(i+1);
        const x = cx + Math.cos(angle - Math.PI/2) * 120;
        const y = cy - Math.sin(angle - Math.PI/2) * 120;
        line(cx,cy,x,y,'#e879f9',2); circle(x,y,20,'#a855f7'); text(x,y+1,num2,14,'#fff');
      }
      document.getElementById('treeText').textContent = `Repeated addition: ${Array(num1).fill(num2).join(' + ')}`;
      document.getElementById('treeResult').textContent = `${num1} √ó ${num2} = ${product}`;

      function circle(x,y,r,fill){ const c=document.createElementNS('http://www.w3.org/2000/svg','circle'); c.setAttribute('cx',x); c.setAttribute('cy',y); c.setAttribute('r',r); c.setAttribute('fill',fill); svg.appendChild(c); }
      function line(x1,y1,x2,y2,stroke,w){ const l=document.createElementNS('http://www.w3.org/2000/svg','line'); l.setAttribute('x1',x1); l.setAttribute('y1',y1); l.setAttribute('x2',x2); l.setAttribute('y2',y2); l.setAttribute('stroke',stroke); l.setAttribute('stroke-width',w); svg.appendChild(l); }
      function text(x,y,txt,size,fill){ const t=document.createElementNS('http://www.w3.org/2000/svg','text'); t.setAttribute('x',x); t.setAttribute('y',y); t.setAttribute('text-anchor','middle'); t.setAttribute('dominant-baseline','middle'); t.setAttribute('font-size',size); t.setAttribute('font-weight','800'); t.setAttribute('fill',fill); t.textContent=txt; svg.appendChild(t); }
    }

    document.getElementById('swapBtn').addEventListener('click', () => { const tmp=num1; num1=num2; num2=tmp; syncButtons('num1Btns', num1); syncButtons('num2Btns', num2); updateVisualization(); });
    document.getElementById('randomBtn').addEventListener('click', () => { setNum1(1+Math.floor(Math.random()*10)); setNum2(1+Math.floor(Math.random()*10)); });

    document.getElementById('commHint').addEventListener('click', () => {
      alert('Commutative Property: a √ó b = b √ó a.\n\nYou can see it by rotating the grid ‚Äî 3 rows √ó 4 columns has the same number of squares as 4 rows √ó 3 columns.');
    });

    window.addEventListener('keydown', (e) => {
      if (['INPUT','TEXTAREA'].includes(document.activeElement.tagName)) return;
      if (currentViz !== 'practice' && currentViz !== 'factorization') {
        if (e.key === 'ArrowUp') setNum1(clamp(num1+1,1,12));
        else if (e.key === 'ArrowDown') setNum1(clamp(num1-1,1,12));
        else if (e.key === 'ArrowRight') setNum2(clamp(num2+1,1,12));
        else if (e.key === 'ArrowLeft') setNum2(clamp(num2-1,1,12));
        else if (/^[1-9]$/.test(e.key)) { const n = Number(e.key); setNum2(n); }
      }
    });

    function init(){
      buildButtons('num1Btns', setNum1, num1);
      buildButtons('num2Btns', setNum2, num2);
      setActiveTab('grid');
      syncButtons('num1Btns', num1); 
      syncButtons('num2Btns', num2);
      updateVisualization();
    }
    init();
  </script>
</body>
</html>
